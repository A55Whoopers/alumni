<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOME | TUP - Cavite</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;500;700&family=Albert+Sans:wght@400;500;700&family=Sanchez&display=swap" rel="stylesheet" />
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Font Awesome for Social Media Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <link rel="icon" type="image/png" href="/Logo2.png">


  <!-- External CSS -->
  <link rel="stylesheet" href="user-homepage.css" />
</head>
<body>
  <div class="userpage">
    <img class="Navbar" src="Navbar.png" />
    <div class="Line1"></div>
    <div class="Line2"></div>


<div class="search-container">
  <input 
    type="text" 
    id="feedSearch" 
    placeholder="🔍 Search events or careers..."
    oninput="filterFeed()"
  />
</div>


    <div id="notificationAlert" class="notification-modal">
      <div class="notification-box">
        <span id="closeNotification" class="notification-close">&times;</span>
        <div id="notificationMessage" class="notification-message"></div>
      </div>
    </div>



    <!-- ID Request Button -->
    <div class="id-button slide-in" onclick="openIdRequestPopup()">
      <div class="content">
        <div class="state-layer">
          <div class="hover-underline1">ID REQUEST</div>
        </div>
      </div>
    </div>

    <!-- ID Request Modal -->
    <div id="idRequestPopup" class="ID-popup-overlay">
      <div class="ID-popup-content">
        <div class="navbar"></div>
        <img class="Logo3" src="Logo2.png" alt="TUPC Logo" />
        <div class="id-selection">ID REQUEST FORM</div>
          <span class="id-selection-span">ID Request</span>
          <span class="id-selection-span2">FORM</span>


            <form id="idRequestForm" enctype="multipart/form-data" onsubmit="event.preventDefault(); submitIdRequestForm();">
              <label>Upload Valid ID *</label>
              <input type="file" name="idImage" required>

              <label for="fullName">Full Name on Official Records *</label>
              <input 
                type="text" 
                name="fullName" 
                id="fullName" 
                required 
                maxlength="30" 
                oninput="this.value = formatName(this.value)"
              />

              <label for="degree">Course Major in. [BET-COET/BTVTED-ET] *</label>
              <input 
                type="text" 
                name="degree" 
                id="degree" 
                required 
                maxlength="9" 
                oninput="this.value = formatDegree(this.value)"
              />

              <label for="yearGraduated">Year Graduated *</label>
              <input 
                type="text" 
                name="yearGraduated" 
                id="yearGraduated" 
                required 
                maxlength="4" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />

              <label for="studentNo">Student No. *</label>
              <input 
                type="text" 
                name="studentNo" 
                id="studentNo" 
                required 
                maxlength="4" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />

              <label for="idRequestPhoneNo">Phone No. *</label>
              <input 
                type="tel" 
                name="phoneNo" 
                id="idRequestPhoneNo" 
                required 
                maxlength="12" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />

              <label for="email">Personal Email Address *</label>
              <input 
                type="email" 
                name="email" 
                id="email" 
                required 
                maxlength="40" 
                oninput="this.value = this.value.replace(/\s/g, '')"
              />
            </form>

        <div class="popup-buttons">
          <button class="id-btn1" onclick="submitIdRequestForm()">Submit</button>
          <button class="id-btn2" onclick="closeIdRequestPopup()">Close</button>
        </div>
      </div>
    </div>

    <div id="popupMessage" class="popup-message hidden">
      <span id="popupText"></span>
    </div>

    
    <div class="gallery-button slide-in" onclick="window.location.href='gallery-user.html?from=user-homepage.html'">
      <div class="content">
        <div class="state-layer">
          <div class="hover-underline1">GALLERY</div>
        </div>
      </div>
    </div>


    <button id="signOutBtn" class="sign-out-button slide-in">
      <div class="content"><div class="state-layer"><div class="hover-underline1">SIGN-OUT</div></div></div>
    </button>

    <div id="loader-wrapper">
      <div class="loader-content">
          <span class="loading-span">T</span>
          <span class="loading-span2">ECHNOLOGICAL</span>
          <span class="loading-span">U</span>
          <span class="loading-span2">NIVERSITY OF THE</span>
          <span class="loading-span">P</span>
          <span class="loading-span2">HILIPPINES - </span>
          <span class="loading-span">C</span>
          <span class="loading-span2">AVITE</span>

        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="percentage" id="percentage">0%</div>
        <div class="footer-text">LOADING PLEASE WAIT</div>
      </div>
    </div>


    <a href="user-homepage.html">
      <img class="Logo" src="Logo.png" alt="University Logo" />
    </a>

    <div class="a-l-u-m-n-i slide-in">
      <span class="a-l-u-m-n-i-span">A</span>
      <span class="a-l-u-m-n-i-span2">l u m n i</span>
      <span class="a-l-u-m-n-i-span">U</span>
      <span class="a-l-u-m-n-i-span2">s e r</span>
    </div>

    <div class="technological-university-of-the-philippines-cavite">
      TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES – CAVITE
    </div>


    <div class="announcement-box">
      <h3>ID Announcements</h3>
      <div class="announcement-list" id="idAnnouncementList">
        Loading...
      </div>
    </div>

    <div class="announcement-box2">
      <h3>Events Announcements</h3>
      <div class="announcement-list" id="eventList">
        Loading...
      </div>
    </div>

    <div class="career-box">
      <h3>Career Opportunities</h3>
      <div class="career-list" id="careerList">
        Loading...
      </div>
    </div>






<!-- Profile picture trigger (Dashboard Circle) -->
<img id="profilePic"
     src="/public/images/default-profile.png"
     alt=""
     class="profile-circle"
     onclick="openProfileModal()">

<!-- Modal -->
<div id="modal-profile" class="modal-profile">
  <div class="modal-profile-content">

    <!-- Profile Card Layout -->
    <div class="profile-card">
      
      <!-- LEFT: Circle Profile Pic -->
      <div class="profile-left">
        <div class="profile-pic-frame">
          <img id="modalProfilePic" src="/public/images/default-profile.png" alt="" class="profile-pic">
        </div>
        <p class="profile-label">PROFILE PICTURE</p>
      </div>

      <!-- RIGHT: Name + Buttons -->
      <div class="profile-right">
        <h2 id="name">NAME</h2>
        <div class="profile-buttons">
          <button id="viewApplicationsBtn" class="profile-btn">View Applications</button>
          <!-- Applications Modal -->
          <div id="applicationsModal" class="modal-applications">
            <div class="modal-app-content">
              <h3>MY APPLICATIONS</h3>
              <table class="applications-table">
                <thead>
                  <tr>
                    <th>COMPANY</th>
                    <th>POSITION</th>
                    <th>DATE APPLIED</th>
                    <th>RESUME</th>
                  </tr>
                </thead>
                <tbody id="applicationsTableBody">
                  <tr><td colspan="4">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>


          <button id="changePicBtn" class="profile-btn">Change Profile Picture</button>
          <input type="file" id="uploadProfilePic" accept="image/*" style="display:none;">
          <button id="editBtn" class="profile-btn edit-btn">Edit Profile</button>
          <button id="saveBtn" class="profile-btn save-btn" style="display:none;">Save</button>

          <!-- 🔹 New: Confirm + Notice -->
          <div id="profileNotice" class="profile-notice hidden"></div>
          <button id="confirmProfileBtn" class="profile-btn" style="display:none;">
            Confirm Profile
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden details (always visible now) -->
    <div id="profile-details" class="profile-details">
      <p><strong>Username:</strong> <span id="userName">-</span></p>
      <p>
        <strong>Email:</strong> 
        <span id="personalEmail">-</span>
        <input type="email" id="editPersonalEmail" style="display:none;">
      </p>
      <p>
        <strong>Civil Status:</strong> 
        <span id="civilStatus">-</span>
        <input type="text" id="editCivilStatus" style="display:none;">
      </p>
      <p>
        <strong>Phone No.:</strong> 
        <span id="phoneNo">-</span>
        <input type="text" id="editPhoneNo" style="display:none;">
      </p>
      <p><strong>Gender:</strong> <span id="gender">-</span></p>
      <p><strong>Date of Birth:</strong> <span id="dateBirth">-</span></p>
      <p><strong>Major:</strong> <span id="major">-</span></p>
      <p><strong>Year Started:</strong> <span id="yearStarted">-</span></p>
      <p><strong>Graduated:</strong> <span id="graduated">-</span></p>
    </div>

  </div>
</div>









<div id="feed"></div>

<!-- Toast Notification -->
<div id="toast"></div>

<div id="mensBasketballModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeMensBasketballModal()">&times;</span>
    <h2>🏀 Men's Basketball Registration</h2>
    <form id="mensBasketballForm">
      
      <!-- ✅ Team Name -->
      <label for="teamName">Team Name</label>
      <input 
        type="text" 
        id="teamName" 
        name="teamName" 
        maxlength="20" 
        required 
        placeholder="Enter Team Name"
        oninput="validateTeamName(this)"
      />

      <!-- ✅ Age Range -->
      <label for="ageRange">Age Range</label>
      <input 
        type="text" 
        id="ageRange" 
        name="ageRange" 
        maxlength="5" 
        required 
        placeholder="e.g. 18-25"
        oninput="validateAgeRange(this)"
      >

      <!-- ✅ Members -->
      <div id="membersContainer">
      <div class="member">
        <input 
          type="text" 
          name="firstName[]" 
          placeholder="First Name" 
          maxlength="20" 
          required
          oninput="validateName(this)"
        >
        <input 
          type="text" 
          name="middleInitial[]" 
          placeholder="M.I." 
          maxlength="1"
          oninput="validateMiddleInitial(this)"
        >
        <input 
          type="text" 
          name="lastName[]" 
          placeholder="Last Name" 
          maxlength="20" 
          required
          oninput="validateName(this)"
        >
      </div>
    </div>

      <button type="button" class="add-member-btn" onclick="addMember()">+ Add Member</button>
      <button type="submit">Register</button>
    </form>
  </div>
</div>



<!-- Career Survey Modal -->
<div id="careerSurveyModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeCareerSurvey()">&times;</span>
    <h2>Career Survey</h2>
    <form id="careerSurveyForm">
      <div id="surveyQuestions"></div>
      <button type="submit" class="submit-btn">Submit Survey</button>
    </form>
  </div>
</div>

<!-- Employment Application Modal -->
<div id="employmentFormModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeEmploymentForm()">&times;</span>
    <h2>Employment Application</h2>
      <form id="employmentForm" enctype="multipart/form-data">
        <input type="hidden" name="careerId" value="CAREER_ID_HERE">
        <label>First Name</label>
        <input type="text" name="firstName" required maxlength="20" oninput="validateNameC(this)">

        <label>Last Name</label>
        <input type="text" name="lastName" required maxlength="20" oninput="validateNameC(this)">

        <label for="employmentPhoneNo">Phone No.</label>
              <input 
                type="tel" 
                name="phoneNo" 
                id="employmentPhoneNo" 
                required 
                maxlength="12" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />
        <label>Personal Email Address</label>
        <input type="email" name="email" required>
        <label>RESUME PDF TYPE</label>
        <input type="file" name="resume" accept="application/pdf" required>
        <button type="submit">Apply</button>
      </form>
  </div>
</div>



<!-- 🔹 Homecoming Modal -->
<div id="modal-home" class="modal-home" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-home-content">
    
    <!-- Header -->
    <div class="modal-home-header">
      <h2>Homecoming Event Registration</h2>
      <span class="modal-home-close" id="modal-home-close">&times;</span>
    </div>

    <!-- Body -->
    <div class="modal-home-body">
      <form id="homecomingForm" enctype="multipart/form-data">
        
        <!-- Name Inputs -->
        <input type="text" name="firstName" id="firstName"
               placeholder="First Name" required maxlength="20"
               oninput="this.value = formatName(this.value)" />
        
        <input type="text" name="middleInitial" id="middleInitial"
               placeholder="Middle Initial" maxlength="1"
               oninput="this.value = this.value.replace(/[^a-zA-Z]/g, '').toUpperCase()" />
        
        <input type="text" name="lastName" id="lastName"
               placeholder="Last Name" required maxlength="20"
               oninput="this.value = formatName(this.value)" />

        <!-- Sex -->
        <label>Sex:</label>
        <select name="sex" required>
          <option value="" disabled selected>Select Sex</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>

        <!-- Program -->
        <label>Program:</label>
        <select name="program" required>
          <option value="" disabled selected>Select Program</option>
          <option value="BET">BET</option>
          <option value="BTVTED">BTVTED</option>
          <option value="Other">Other</option>
        </select>

        <!-- Year Graduated -->
        <input type="text" name="yearGraduated" id="yearGraduated"
               placeholder="Year Graduated" required maxlength="4"
               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)" />

        <!-- Add-ons -->
        <label>Add-on Options:</label>
        <div class="addon-group">
          <label><span>₱100 – Additional four (4) drinks</span>
            <input type="radio" name="addon" value="100" required>
          </label>
          <label><span>₱500 – Additional unlimited drinks</span>
            <input type="radio" name="addon" value="500">
          </label>
          <label>  <span>I do not want an add-on</span>
              <input type="radio" name="addon" value="no addon">
          </label>
        </div>

        <!-- Receipt -->
        <label>Upload Receipt (PNG/JPG only):</label>
        <input type="file" name="receipt" id="receiptInput" accept="image/png, image/jpeg" />

        <!-- GCash Button -->
        <button type="button" id="gcashBtn" class="gcash-button" onclick="openModal()">
          View GCash Payment QR Code
        </button>

        <div id="gcashModal" class="modal-home" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-home-content">
          <div class="modal-home-header">
            <h2>GCash Payment</h2>
            <span class="modal-home-close" onclick="closeModal()">&times;</span>
          </div>
          <div class="modal-home-body">
            <div id="modalImageContainer">
              <!-- QR Code will be inserted here -->
            </div>
          </div>
        </div>
      </div>

        <!-- Submit -->
        <button type="submit">REGISTER</button>
      </form>
    </div>
  </div>
</div>

<div id="sportfestModal" class="modal-sportfest" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-sportfest-content">
    <h2>Sport Fest Event Registration</h2>
    <span class="modal-sportfest-close" onclick="closeSportfestModal()">&times;</span>

    <form id="sportfestForm">
      <!-- First Name -->
      <input type="text" name="firstName" placeholder="First Name" maxlength="20" required
             oninput="this.value=this.value
               .replace(/[^A-Za-z ]/g,'')        /* allow only letters + spaces */
               .replace(/\s+/g,' ')              /* collapse multiple spaces */
               .replace(/\b\w/g, c => c.toUpperCase());" />

      <!-- Middle Initial (1 letter only) -->
      <input type="text" name="middleInitial" placeholder="M" maxlength="1"
             oninput="this.value=this.value.replace(/[^A-Za-z]/g,'').toUpperCase()" />

      <!-- Last Name -->
      <input type="text" name="lastName" placeholder="Last Name" maxlength="20" required
             oninput="this.value=this.value
               .replace(/[^A-Za-z ]/g,'')        
               .replace(/\s+/g,' ')              
               .replace(/\b\w/g, c => c.toUpperCase());" />

      <!-- Gender -->
      <select name="sex" required>
        <option value="" disabled selected>Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>

      <!-- Extension (letters only, up to 4) -->
      <input type="text" name="extension" placeholder="Extension (e.g., Jr, Sr)" maxlength="4"
             oninput="this.value=this.value.replace(/[^A-Za-z]/g,'').toUpperCase()" />

      <!-- Batch/Year Graduated (4 digits only) -->
      <input type="text" name="batch" placeholder="Batch / Year Graduated" maxlength="4" required
             oninput="this.value=this.value.replace(/[^0-9]/g,'')" />

      <!-- Auto-filled from feed -->
      <p id="sportfestLocation" 
         style="text-align:left; margin:10px 0; font-weight:600; font-size:1.1rem; color:#ffd54f; font-family: Arial, sans-serif;">
      </p>
      <input type="hidden" name="sportType" id="sportTypeField" />

      <button type="submit">Register</button>
    </form>
  </div>
</div>



<div class="user-name">
  <i class="fas fa-user-circle"></i>
  <span id="displayName"></span>
</div>



<!-- Survey Notification -->
<div id="surveyNotification" class="survey-notification">
  <span id="surveyNotificationMsg"></span>
  <button class="survey-close-btn" onclick="closeSurveyNotification()">×</button>
</div>

<!-- Toast container -->
<div id="toast-container"></div>


<small id="teamNameError" style="color:red;"></small>

<script type="module">
  import { setupSignOut } from './sign-out.js';
  setupSignOut('user');

  async function loadIdAnnouncements() {
    const container = document.getElementById('idAnnouncementList');
    container.innerHTML = 'Loading...';

    try {
      const res = await fetch('/api/admin/id-announcements');
      if (!res.ok) throw new Error('Failed to load ID announcements');
      const { announcements } = await res.json();

      container.innerHTML = announcements.map(a => `
        <div class="event-card">
          <div class="event-header">
            <span class="badge">ID ANNOUNCEMENT</span>
            <span class="posted-date">Posted: ${new Date(a.datePosted).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
          </div>
          <div class="event-title">${a.title}</div>
          <p>${a.description}</p>
        </div>
      `).join('') || '<div>No announcements found.</div>';

    } catch (err) {
      container.innerHTML = `<div class="error">❌ Failed to load announcements</div>`;
      console.error(err);
    }
  }

  document.addEventListener('DOMContentLoaded', loadIdAnnouncements);

  async function loadEvents() {
    const container = document.getElementById('eventList');
    container.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/events');
      if (!res.ok) throw new Error('Failed to load events');
      const { events } = await res.json();

      container.innerHTML = events.map(e => `
        <div class="event-card">
          <div class="event-header">
            <span class="badge">EVENT ANNOUNCEMENT</span>
            <span class="posted-date">Posted: ${new Date(e.datePosted).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
          </div>
          <div class="event-title">${e.title}</div>
        </div>
      `).join('') || '<div>No announcements found.</div>';

    } catch (err) {
      container.innerHTML = `<div class="error">❌ Failed to load announcements</div>`;
      console.error(err);
    }
  }

  document.addEventListener('DOMContentLoaded', loadEvents);

async function loadCareers() {
  const listContainer = document.getElementById('careerList');
  listContainer.innerHTML = 'Loading...';

  try {
    const role = sessionStorage.getItem("userRole"); // "admin", "employer", "user"
    let careersUrl;

    if (role === "admin") {
      careersUrl = "/api/careers/all";
    } else if (role === "employer") {
      careersUrl = "/api/careers"; // employer-specific (session based)
    } else {
      careersUrl = "/api/careers/public"; // users → new route
    }

    const res = await fetch(careersUrl);
    if (!res.ok) throw new Error('Failed to load careers');

    const { careers } = await res.json();

    listContainer.innerHTML = careers.slice(0, 10).map(career => `
      <div class="career-card">
        <div class="career-header">
          <span class="career-badge">CAREER</span>
          Posted: ${new Date(career.datePosted).toLocaleDateString()}
        </div>
        <div class="career-title">${career.title}</div>
      </div>
    `).join('') || '<div>No announcements found.</div>';
  } catch (err) {
    console.error("❌ Career load error:", err);
    listContainer.innerHTML = '❌ Failed to load careers';
  }
}

document.addEventListener('DOMContentLoaded', loadCareers);


  window.addEventListener('DOMContentLoaded', () => {
    const role = sessionStorage.getItem('userRole');
    if (!role) {
      window.location.href = 'homepage.html';
    } else if (role === 'admin') {
      window.location.href = 'admin-homepage.html';
    } else {
      loadIdAnnouncements();  // ✅ Correct function call!
    }
  });
</script>

  <!-- Modal Script -->
<script>
  function formatDegree(value) {
    // Allow only letters and dashes, remove others
    value = value.replace(/[^a-zA-Z\-]/g, '');

    // Only allow first dash
    const firstDash = value.indexOf('-');
    if (firstDash !== -1) {
      value = value.substring(0, firstDash + 1) + value.substring(firstDash + 1).replace(/\-/g, '');
    }

    // Convert to uppercase
    return value.toUpperCase();
  }
  function formatName(value) {
    // Remove numbers and special characters, keep letters and spaces
    value = value.replace(/[^a-zA-Z\s]/g, '');

    // Capitalize the first letter of each word
    return value.replace(/\b\w/g, char => char.toUpperCase());
  }


// Loading Screen Script
document.addEventListener("DOMContentLoaded", () => {
let percentage = 80;
const loaderWrapper = document.getElementById("loader-wrapper");
const progressBar = document.getElementById("progress-bar");
const percentageText = document.getElementById("percentage");

const loadingInterval = setInterval(() => {
  if (percentage < 100) {
    percentage++;
        progressBar.style.width = percentage + "%";
        percentageText.textContent = percentage + "%";
      } else {
        clearInterval(loadingInterval);
        loaderWrapper.style.display = "none";
      }
    }, 30);
  });

  // Facebook SDK Initialization
  window.fbAsyncInit = function () {
    FB.init({
      xfbml: true,
      version: 'v17.0'
    });
  };

  (function (d, s, id) {
    if (d.getElementById(id)) return;
    let js = d.createElement(s);
    js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    d.head.appendChild(js);
  }(document, 'script', 'facebook-jssdk'));

  // Career Popup Script
  document.addEventListener("DOMContentLoaded", () => {
    // Open popup
    window.openCareerPopup = function () {
      document.getElementById('careerPopup').style.display = 'block';
    };

    // Close popup and clear the form
    window.closeCareerPopup = function () {
      document.getElementById('careerPopup').style.display = 'none';

      // Clear the form inputs
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('interested').selectedIndex = 0;
      document.getElementById('employmentStatus').selectedIndex = 0;
    };
  });

  function submitCareerForm() {
    const payload = {
      firstName: document.getElementById('firstName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      interested: document.getElementById('interested').value,
      employmentStatus: document.getElementById('employmentStatus').value
    };

    fetch('/api/responses/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(async res => {
      const text = await res.text();
      console.debug('Response status:', res.status);
      console.debug('Response body:', text);
      if (!res.ok) throw new Error(text);
      return JSON.parse(text);
    })
    .then(data => {
      showNotification(`✅ Submission successful!`);
      setTimeout(() => {
        window.location.href = 'career-post.html';
      }, 3000);
    })
    .catch(err => {
      console.error('Submission failed:', err);
      showNotification(`Please fill up all the requirment`);
    });
  }

  function showNotification(message) {
    const popup = document.getElementById('notificationAlert');
    const msg = document.getElementById('notificationMessage');
    msg.textContent = message;
    popup.style.display = 'flex';

    setTimeout(() => {
      popup.style.display = 'none';
    }, 3000);
  }

  document.getElementById('closeNotification').onclick = () => {
    document.getElementById('notificationAlert').style.display = 'none';
  };

  document.addEventListener("DOMContentLoaded", () => {
    const galleryBtn = document.getElementById('galleryBtn');
    if (galleryBtn) {
      galleryBtn.onclick = () => {
        window.location.href = 'gallery-user.html?from=user-homepage.html';
      };
    }
  });

// Open the ID Request Popup
function openIdRequestPopup() {
  document.getElementById('idRequestPopup').style.display = 'flex';
}

// Close and Clear the Form using Form Reset
function closeIdRequestPopup() {
  const form = document.getElementById('idRequestForm');
  if (form) form.reset();  // ✅ Reset all form fields at once

  document.getElementById('idRequestPopup').style.display = 'none';
}

function submitIdRequestForm() {
  const formElement = document.getElementById('idRequestForm');
  const formData = new FormData(formElement);

  fetch('/api/requests/add', {
    method: 'POST',
    body: formData
  })
  .then(async res => {
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Unknown error');
    showPopup('✅ Submission Successful!');
    closeIdRequestPopup();
  })
  .catch(err => {
    showPopup('❌ Submission failed: ' + err.message, true);
  });
}

function showPopup(message, isError = false) {
  const popup = document.getElementById('popupMessage');
  const popupText = document.getElementById('popupText');

  popupText.textContent = message;
  popup.classList.remove('error', 'show');
  if (isError) popup.classList.add('error');
  
  // Force reflow for animation reset
  void popup.offsetWidth; 
  popup.classList.add('show');

  // Hide after 3 seconds
  setTimeout(() => popup.classList.remove('show'), 3000);
}


function showEmployerToast(message, type = 'success') {
  const toast = document.getElementById('employer-toast');
  const toastMsg = document.getElementById('employer-toast-msg');
  toastMsg.textContent = message;

  toast.className = `employer-toast show ${type}`;
  setTimeout(() => {
    toast.className = 'employer-toast';
  }, 3000);
}

function showLoginToast(message, type = 'success') {
  const toast = document.getElementById('login-toast');
  const toastMsg = document.getElementById('login-toast-message');
  toastMsg.textContent = message;
  toast.className = `toast show ${type}`;

  setTimeout(() => {
    toast.className = 'toast';  // Hide after 3 seconds
  }, 3000);
}


/////////////////////////////////////////////////////////////////////////////////////
/* ---------------------------
   Load Profile Data (Shared)
---------------------------- */
async function loadProfileData(updateModal = false) {
  const profilePic = document.getElementById("profilePic");
  const modalProfilePic = document.getElementById("modalProfilePic");

  try {
    const res = await fetch("/api/fullInformation/me", {
      credentials: "include",
      cache: "no-store"
    });
    if (!res.ok) throw new Error("Not logged in");

    const data = await res.json();

    // ✅ Profile picture
    const pic = data.profilePic || "/public/images/default-profile.png";
    if (profilePic) profilePic.src = pic;
    if (updateModal && modalProfilePic) modalProfilePic.src = pic;

    // ✅ Basic info
    document.getElementById("name").textContent =
    ([data.firstName, data.lastName].filter(Boolean).join(" ") || "No Name").toUpperCase()
    document.getElementById("userName").textContent = data.userName || "-";
    document.getElementById("personalEmail").textContent = data.personalEmail || "-";
    document.getElementById("gender").textContent = data.gender || "-";

    // ✅ Extra info
    document.getElementById("civilStatus").textContent = data.civilStatus || "-";
    document.getElementById("dateBirth").textContent = data.dateBirth
      ? new Date(data.dateBirth).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        })
      : "-";

    // ✅ Phone number
    const phoneSpan = document.getElementById("phoneNo");
    const phoneInput = document.getElementById("editPhoneNo");
    if (phoneSpan) phoneSpan.textContent = data.phoneNo || "-";
    if (phoneInput) phoneInput.value = data.phoneNo || "";

    document.getElementById("major").textContent = data.major || "-";
    document.getElementById("yearStarted").textContent = data.yearStarted || "-";
    document.getElementById("graduated").textContent = data.graduated || "-";
    document.getElementById("studentNo").textContent = data.studentNo || "-";

  } catch (err) {
    console.error("❌ Error loading user info:", err);
    if (profilePic) profilePic.src = "/public/images/default-profile.png";
  }
}

/* ---------------------------
   Modal Open / Close
---------------------------- */
function openProfileModal() {
  const modal = document.getElementById("modal-profile");
  if (!modal) return;
  modal.style.display = "flex";
  document.getElementById("name").textContent = "Loading...";
  loadProfileData(true);
}

function closeProfileModal() {
  const modal = document.getElementById("modal-profile");
  if (modal) modal.style.display = "none";
}

/* ---------------------------
   Toggle Info Section
---------------------------- */
function toggleInformation() {
  const details = document.getElementById("profile-details");
  if (details) details.classList.toggle("hidden");
}

/* ---------------------------
   Enable Edit Mode
---------------------------- */
function enableEdit() {
  document.getElementById("personalEmail").style.display = "none";
  document.getElementById("editPersonalEmail").style.display = "inline";
  document.getElementById("editPersonalEmail").value =
    document.getElementById("personalEmail").textContent;

  document.getElementById("civilStatus").style.display = "none";
  document.getElementById("editCivilStatus").style.display = "inline";
  document.getElementById("editCivilStatus").value =
    document.getElementById("civilStatus").textContent;

  document.getElementById("phoneNo").style.display = "none";
  document.getElementById("editPhoneNo").style.display = "inline";
  document.getElementById("editPhoneNo").value =
    document.getElementById("phoneNo").textContent;

  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "inline";
}

/* ---------------------------
   Save Profile
---------------------------- */
async function saveProfile() {
  const updatedData = {
    personalEmail: document.getElementById("editPersonalEmail").value,
    civilStatus: document.getElementById("editCivilStatus").value,
    phoneNo: document.getElementById("editPhoneNo").value,
  };

  try {
    const res = await fetch("/api/fullInformation/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(updatedData),
    });
    const data = await res.json();

    if (data.success) {
      showToast("✅ Profile updated!");
      document.getElementById("personalEmail").textContent = updatedData.personalEmail;
      document.getElementById("civilStatus").textContent = updatedData.civilStatus;
      document.getElementById("phoneNo").textContent = updatedData.phoneNo;

      document.getElementById("personalEmail").style.display = "inline";
      document.getElementById("civilStatus").style.display = "inline";
      document.getElementById("phoneNo").style.display = "inline";

      document.getElementById("editPersonalEmail").style.display = "none";
      document.getElementById("editCivilStatus").style.display = "none";
      document.getElementById("editPhoneNo").style.display = "none";

      document.getElementById("editBtn").style.display = "inline";
      document.getElementById("saveBtn").style.display = "none";
    } else {
      showToast("❌ Error: " + data.error, true);
    }
  } catch (err) {
    console.error("❌ Update error:", err);
    showToast("Server error while updating", true);
  }
}

/* ---------------------------
   Profile Picture Upload
---------------------------- */
document.getElementById("uploadProfilePic")?.addEventListener("change", async event => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById("modalProfilePic").src = e.target.result;
    document.getElementById("profilePic").src = e.target.result;
  };
  reader.readAsDataURL(file);

  const formData = new FormData();
  formData.append("profilePic", file);

  try {
    const res = await fetch("/api/fullInformation/upload-picture", {
      method: "POST",
      body: formData,
      credentials: "include",
    });
    const data = await res.json();

    if (data.success && data.imageUrl) {
      document.getElementById("modalProfilePic").src = data.imageUrl;
      document.getElementById("profilePic").src = data.imageUrl;
      showToast("✅ Profile picture updated!");
    } else {
      showToast("❌ Upload failed", true);
    }
  } catch (err) {
    console.error("❌ Upload error:", err);
    showToast("Server error while uploading", true);
  }
});

/* ---------------------------
   Applications Modal
---------------------------- */
async function loadApplications(userName) {
  const modal = document.getElementById("applicationsModal");
  const tableBody = document.getElementById("applicationsTableBody");

  modal.style.display = "flex";
  tableBody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

  try {
    const res = await fetch(`/api/applications/user/${encodeURIComponent(userName)}`, {
      credentials: "include"
    });
    if (!res.ok) throw new Error("Failed to fetch applications");

    const apps = await res.json();


    if (!apps.length) {
      tableBody.innerHTML = `<tr><td colspan="4">No applications found.</td></tr>`;
      return;
    }

    tableBody.innerHTML = apps.map(app => `
      <tr>
        <td>${app.company}</td>
        <td>${app.careerTitle}</td>
        <td>${new Date(app.dateSubmitted).toLocaleDateString()}</td>
        <td><a href="/uploads/resumes/${app.resumePath}" target="_blank">View</a></td>
      </tr>
    `).join("");

  } catch (err) {
    console.error("❌ Error loading applications:", err);
    tableBody.innerHTML = `<tr><td colspan="4">⚠️ Error loading applications.</td></tr>`;
  }
}

/* ---------------------------
   Enforce Profile Picture Flow
---------------------------- */
async function enforceProfilePictureFlow() {
  try {
    const res = await fetch("/api/fullInformation/me", { credentials: "include", cache: "no-store" });
    if (!res.ok) return;
    const user = await res.json();

    const modal = document.getElementById("modal-profile");
    const notice = document.getElementById("profileNotice");
    const confirmBtn = document.getElementById("confirmProfileBtn");

    const pic = user.profilePic || "";
    const isDefault = !pic || pic.includes("default-profile.png") || pic.includes("/public/images/default-profile.png");

    if (user.profileConfirmed === 1) {
      delete modal.dataset.locked;
      notice.style.display = "none";
      confirmBtn.style.display = "none";
      return;
    }

    modal.style.display = "flex";
    modal.dataset.locked = "true";

    if (isDefault) {
      notice.style.display = "block";
      notice.textContent = "⚠️ Please upload your profile picture to continue.";
      confirmBtn.style.display = "inline-block";
      confirmBtn.disabled = true;
    } else {
      notice.style.display = "block";
      notice.textContent = "✅ Picture uploaded. Click Confirm to continue.";
      confirmBtn.style.display = "inline-block";
      confirmBtn.disabled = false;
    }
  } catch (err) {
    console.error("❌ enforceProfilePictureFlow error:", err);
  }
}

/* ---------------------------
   Confirm button
---------------------------- */
document.getElementById("confirmProfileBtn")?.addEventListener("click", async () => {
  try {
    const res = await fetch("/api/fullInformation/confirm", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
    });
    const data = await res.json();

    if (res.ok && data.success) {
      const modal = document.getElementById("modal-profile");
      delete modal.dataset.locked;
      modal.style.display = "none";
      document.getElementById("profileNotice").style.display = "none";
      document.getElementById("confirmProfileBtn").style.display = "none";
    } else {
      alert(data.error || "Please upload a profile picture first.");
    }
  } catch (err) {
    console.error("❌ confirmProfileBtn error:", err);
    alert("Server error while confirming profile.");
  }
});

/* ---------------------------
   Upload Hook for Confirm
---------------------------- */
function hookUploadShowConfirm() {
  const input = document.getElementById("uploadProfilePic");
  if (!input) return;

  input.addEventListener("change", () => {
    const tryCheck = async (attempt = 0) => {
      if (attempt > 8) return;
      try {
        const res = await fetch("/api/fullInformation/me", { credentials: "include", cache: "no-store" });
        if (res.ok) {
          const u = await res.json();
          const pic = u.profilePic || "";
          const isDefault = !pic || pic.includes("default-profile.png") || pic.includes("/public/images/default-profile.png");

          if (!isDefault && u.profileConfirmed !== 1) {
            const confirmBtn = document.getElementById("confirmProfileBtn");
            if (confirmBtn) {
              confirmBtn.style.display = "inline-block";
              confirmBtn.disabled = false;
            }
            const notice = document.getElementById("profileNotice");
            if (notice) notice.textContent = "✅ Picture uploaded. Click Confirm to continue.";
            return;
          }
        }
      } catch {}
      setTimeout(() => tryCheck(attempt + 1), 500);
    };
    setTimeout(() => tryCheck(0), 400);
  });
}

/* ---------------------------
   Event Bindings
---------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  // Profile modal
  document.getElementById("profilePic")?.addEventListener("click", openProfileModal);

  // Info toggle
  document.getElementById("viewInfoBtn")?.addEventListener("click", toggleInformation);

  // Edit / Save
  document.getElementById("editBtn")?.addEventListener("click", enableEdit);
  document.getElementById("saveBtn")?.addEventListener("click", saveProfile);

  // Change Picture
  document.getElementById("changePicBtn")?.addEventListener("click", () => {
    document.getElementById("uploadProfilePic").click();
  });

  // Applications
  document.getElementById("viewApplicationsBtn")?.addEventListener("click", () => {
    const userName = document.getElementById("userName")?.textContent.trim();
    if (!userName || userName === "-") {
      alert("⚠️ No username found.");
      return;
    }
    loadApplications(userName);
  });
  document.getElementById("closeApplicationsModal")?.addEventListener("click", () => {
    document.getElementById("applicationsModal").style.display = "none";
  });

  // Close modals on outside click
  window.addEventListener("click", e => {
    const profileModal = document.getElementById("modal-profile");
    const appsModal = document.getElementById("applicationsModal");
    if (e.target === profileModal && profileModal.dataset.locked !== "true") {
      closeProfileModal();
    }
    if (e.target === appsModal) {
      appsModal.style.display = "none";
    }
  });

  // Initial load
  loadProfileData();
  enforceProfilePictureFlow();
  hookUploadShowConfirm();
});

/////////////////////////////////////////////////////////////////////////////////////



function showToast(message, isError = false) {
  const toast = document.getElementById("toast");
  toast.textContent = message;

  toast.style.backgroundColor = isError ? "#d9534f" : "#28a745";
  toast.className = "show";

  setTimeout(() => {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}




// ===== User Feed Loader (Events + Careers with UTC countdown) =====
async function loadFeed() {
  const container = document.getElementById("feed");
  container.innerHTML = "Loading feed...";

  // Always parse as UTC (backend must send ISO strings with Z)
  function parseDate(input) {
    if (!input) return null;
    const d = new Date(input);
    return isNaN(d.getTime()) ? null : d;
  }

  try {
    const role = sessionStorage.getItem("userRole"); // "user" | "employer"
    const careersUrl =
      role === "employer" ? "/api/careers" : "/api/careers/public";

    const [eventsRes, careersRes] = await Promise.all([
      fetch("/api/events"),
      fetch(careersUrl),
    ]);

    if (!eventsRes.ok || !careersRes.ok) throw new Error("Failed to fetch");

    const { events } = await eventsRes.json();
    const { careers } = await careersRes.json();

    const feed = [
      ...(events || []).map(e => ({ ...e, type: "Event" })),
      ...(careers || []).map(c => ({ ...c, type: "Career" })),
    ].sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));

    container.innerHTML = feed.map((post, index) => {
      const imgSrc =
        post.type === "Career"
          ? `/api/careers/image/${post.id}`
          : `/api/events/image/${post.id}`;

      const extraInfo =
        post.type === "Event"
          ? `🎉 Event Type: ${post.location || "N/A"}`
          : `🏢 Company: ${post.link || "N/A"}`;

      let deadlineDate = null;
      if (post.type === "Career") {
        const posted = parseDate(post.datePosted) || new Date();
        deadlineDate = new Date(posted.getTime() + 5 * 24 * 60 * 60 * 1000);
      } else if (post.type === "Event") {
        deadlineDate =
          parseDate(post.eventDateTime) || parseDate(post.datePosted);
      }

      const deadlineMs = deadlineDate ? deadlineDate.getTime() : "";

      return `
        <div class="feed-card" id="feed-card-${post.id}">
          ${imgSrc ? `<img class="feed-img" src="${imgSrc}" alt="">` : ""}
          <div class="feed-content">
            <h2>${(post.title || "").toUpperCase()} <small>[${post.type}]</small></h2>
            <p>${post.description || ""}</p>
            <small>
              ${extraInfo}<br>
              🕒 Posted: ${new Date(post.datePosted).toLocaleString()}<br>
              ⏳ <span class="countdown" data-time="${deadlineMs}" id="countdown-${index}"></span>
            </small>
            ${
              post.type === "Career"
                ? `<button class="register-btn" data-id="${post.id}" data-type="Career">Apply</button>`
                : `<button class="register-btn" data-id="${post.id}" data-type="Event">Register</button>`
            }
          </div>
        </div>`;
    }).join("");

    // Handle register clicks
    container.addEventListener("click", e => {
      const btn = e.target.closest(".register-btn");
      if (!btn) return;
      const type = btn.dataset.type;
      const id = btn.dataset.id;
      const post = feed.find(p => p.id == id && p.type === type);

      if (type === "Career" && window.openCareerSurvey) {
        window.openCareerSurvey(post);
      } else if (type === "Event" && window.openRegistrationModal) {
        window.openRegistrationModal(post);
      }
    });

    // Countdown updater
    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll(".countdown").forEach(el => {
        const ms = Number(el.dataset.time);
        if (!ms || isNaN(ms)) return (el.textContent = "—");

        const diff = ms - now;
        const card = el.closest(".feed-card");
        const btn = card?.querySelector(".register-btn");

        if (diff <= 0) {
          el.textContent = "❌ Closed";
          card.style.filter = "grayscale(100%)";
          if (btn) {
            btn.disabled = true;
            btn.textContent = "❌ Closed";
          }
          return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        el.textContent = d > 0 ? `${d}d ${h}h ${m}m ${s}s left` : `${h}h ${m}m ${s}s left`;
      });
    }

    updateCountdowns();
    setInterval(updateCountdowns, 1000);

  } catch (err) {
    console.error("❌ Failed to load feed:", err);
    container.textContent = "⚠️ Failed to load feed.";
  }
}

document.addEventListener("DOMContentLoaded", loadFeed);




// 🔹 Master modal opener
function openRegistrationModal(post) {
  if (!post || !post.title) {
    console.warn("⚠️ Invalid post passed:", post);
    return;
  }

  switch (post.title.toUpperCase()) {
    case "MENSBASKETBALL":
      openMensBasketballModal(post);
      break;

    case "HOMECOMING EVENT":
      openHomecomingModal(post);
      break;

    case "SPORT FEST EVENT":   // 👈 match exact title from feed
      openSportfestModal(post);
      break;

    case "CAREER FAIR":
      openCareerModal(post);
      break;

    default:
      console.warn("⚠️ No modal opener found for", post.title);
  }
}



// 🔹 Men’s Basketball modal handlers
function openMensBasketballModal() {
  document.getElementById("mensBasketballModal").style.display = "flex";
}

function closeMensBasketballModal() {
  document.getElementById("mensBasketballModal").style.display = "none";
}

function addMember() {
  const container = document.getElementById("membersContainer");
  const div = document.createElement("div");
  div.classList.add("member");
  div.innerHTML = `
    <input type="text" name="firstName[]" placeholder="First Name" required>
    <input type="text" name="middleInitial[]" placeholder="M.I.">
    <input type="text" name="lastName[]" placeholder="Last Name" required>
  `;
  container.appendChild(div);
}

// 🔹 Handle Men’s Basketball form submission
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("mensBasketballForm");
  if (!form) return; // prevent null error

  form.onsubmit = async (e) => {
    e.preventDefault();

    const teamName = document.getElementById("teamName").value.trim();
    const ageRange = document.getElementById("ageRange").value.trim();

    // Collect all players
    const firstNames = document.querySelectorAll("input[name='firstName[]']");
    const middleInitials = document.querySelectorAll("input[name='middleInitial[]']");
    const lastNames = document.querySelectorAll("input[name='lastName[]']");

    const players = [];
    firstNames.forEach((input, i) => {
      if (input.value.trim() || lastNames[i].value.trim()) {
        players.push({
          firstName: input.value.trim(),
          middleInitial: middleInitials[i].value.trim(),
          lastName: lastNames[i].value.trim()
        });
      }
    });

    // ✅ Enforce min 10, max 20 players
    if (players.length < 10) {
      showToast("⚠️ You need at least 10 members to register a team.");
      return;
    }
    if (players.length > 20) {
      showToast("⚠️ Maximum 20 members are allowed per team.");
      return;
    }

    const payload = { teamName, ageRange, players };

    try {
      const res = await fetch("/api/sportfest/mensBasketball", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to register");

      showToast(`✅ Team registered successfully! Players: ${data.playerCount}`);
      closeMensBasketballModal();
    } catch (err) {
      showToast("❌ Error: " + err.message);
    }
  };
});









function openCareerSurvey(career) {
  window.currentCareer = career; // save globally for employment form

  const modal = document.getElementById("careerSurveyModal");
  const container = document.getElementById("surveyQuestions");

  container.innerHTML = `
    <label>First Name</label>
    <input type="text" name="firstName" maxlength="20" required oninput="validateNameC(this)">

    <label>Last Name</label>
    <input type="text" name="lastName" maxlength="20" required oninput="validateNameC(this)">

    <label>Are you interested?</label>
    <select name="interested" required>
      <option value="">-- Select --</option>
      <option value="YES">YES</option>
      <option value="NO">NO</option>
    </select>

    <label>What is your current employment status?</label>
    <select name="employmentStatus" required>
      <option value="">-- Select --</option>
      <option value="EMPLOYED">EMPLOYED</option>
      <option value="UNEMPLOYED">UNEMPLOYED</option>
      <option value="UNDEREMPLOYED">UNDEREMPLOYED</option>
    </select>

    <label>If employed, is your work inline with this career?</label>
    <select name="inlineWork">
      <option value="">-- Select --</option>
      <option value="YES">YES</option>
      <option value="NO">NO</option>
      <option value="MAYBE">MAYBE</option>
    </select>
  `;

  modal.style.display = "flex";

  // ✅ Survey Submit
  const surveyForm = document.getElementById("careerSurveyForm");
  if (surveyForm) {
    surveyForm.onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      const payload = {
        careerId: career.id,
        firstName: formData.get("firstName"),
        lastName: formData.get("lastName"),
        interested: formData.get("interested"),
        employmentStatus: formData.get("employmentStatus"),
        inlineWork: formData.get("inlineWork") || null,
      };

      try {
        const res = await fetch("/api/responses/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to save survey");

        closeCareerSurvey();

        if (payload.interested === "NO") {
          showSurveyNotification("❌ You are not interested. Career description will not be shown.", "error");
        } else {
          document.getElementById("employmentFormModal").style.display = "flex";
        }
      } catch (err) {
        console.error("❌ Survey submit error:", err);
        showSurveyNotification("❌ Failed to save your survey. Please try again.", "error");
      }
    };
  }
}

// ✅ Employment Form Submit (only bind once globally)
document.addEventListener("DOMContentLoaded", () => {
  const employmentForm = document.getElementById("employmentForm");
  if (!employmentForm) return;

  employmentForm.onsubmit = async function (e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    // ✅ Fix: use set() so careerId is not duplicated
    formData.set("careerId", window.currentCareer?.id || ""); 

    try {
      const res = await fetch(`/api/applications/add`, {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to submit application");

      showSurveyNotification("✅ Employment Application Submitted Successfully!", "success");
      closeEmploymentForm();
    } catch (err) {
      console.error("❌ Application submit error:", err);
      showSurveyNotification("❌ Failed to submit application. Please try again.", "error");
    }
  };
});



function closeCareerSurvey() {
  document.getElementById("careerSurveyModal").style.display = "none";
}

function closeEmploymentForm() {
  document.getElementById("employmentFormModal").style.display = "none";
}

function showSurveyNotification(message, type = "success") {
  const box = document.getElementById("surveyNotification");
  const msg = document.getElementById("surveyNotificationMsg");

  msg.innerHTML = message;
  box.className = `survey-notification ${type}`;
  box.style.display = "flex";
}

function closeSurveyNotification() {
  document.getElementById("surveyNotification").style.display = "none";
}






function validateAgeRange(input) {
  // Allow only numbers and dash (-)
  input.value = input.value.replace(/[^0-9-]/g, "");

  // Limit to 5 characters
  if (input.value.length > 5) {
    input.value = input.value.slice(0, 5);
  }
}
function validateName(input) {
  // Remove non-letters
  input.value = input.value.replace(/[^a-zA-Z ]/g, "");

  // Capitalize first letter of each word
  input.value = input.value.replace(/\b\w/g, char => char.toUpperCase());
}

function validateMiddleInitial(input) {
  // Keep only one alphabetic character (A–Z or a–z)
  input.value = input.value.replace(/[^a-zA-Z]/g, '').slice(0, 1);
}

function validateTeamName(input) {
  const msg = document.getElementById("teamNameError");
  const regex = /^[a-zA-Z0-9 ]*$/;

  if (!regex.test(input.value)) {
    msg.textContent = "❌ Only letters, numbers, and spaces allowed.";
  } else {
    msg.textContent = "";
  }
}

function validateNameC(input) {
  // Remove everything except letters & spaces
  input.value = input.value.replace(/[^a-zA-Z\s]/g, '');

  // Convert to uppercase
  input.value = input.value.toUpperCase();

  // Enforce max length (just in case)
  if (input.value.length > 20) {
    input.value = input.value.slice(0, 20);
  }
}


function filterFeed() {
  const query = document.getElementById("feedSearch").value.toLowerCase();
  const cards = document.querySelectorAll(".feed-card");

  cards.forEach(card => {
    const text = card.innerText.toLowerCase();
    if (text.includes(query)) {
      card.style.display = "block";
    } else {
      card.style.display = "none";
    }
  });
}


function showToast(message, type = "info") {
  const container = document.getElementById("toast-container");

  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;

  container.appendChild(toast);

  // Auto remove after 4s
  setTimeout(() => {
    toast.style.animation = "fadeOut 0.5s forwards";
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}





let lastFocusedElement; 
let gcashEnabled = true; // default, updated from localStorage

/* 🔹 Homecoming Modal */
function openHomecomingModal() {
  lastFocusedElement = document.activeElement;
  const modal = document.getElementById("modal-home");
  modal.style.display = "flex";
  modal.removeAttribute("inert");
  modal.setAttribute("aria-hidden", "false");

  const firstInput = modal.querySelector("input, select, button");
  if (firstInput) firstInput.focus();
}

function closeHomecomingModal() {
  const modal = document.getElementById("modal-home");
  modal.style.display = "none";
  modal.setAttribute("inert", "");
  modal.setAttribute("aria-hidden", "true");

  if (lastFocusedElement) lastFocusedElement.focus();
}

document.getElementById("modal-home-close")
  .addEventListener("click", closeHomecomingModal);

window.addEventListener("click", (e) => {
  const modal = document.getElementById("modal-home");
  if (e.target === modal) closeHomecomingModal();
});

document.addEventListener('keydown', function (e) {
  if (e.key === 'Escape') closeHomecomingModal();
});

/* 🔹 GCash Modal */
function openModal() {
  if (!gcashEnabled) {
    showToast("❌ GCash payment option is currently disabled by admin.", "error");
    return;
  }

  lastFocusedElement = document.activeElement;
  const modal = document.getElementById('gcashModal');
  const container = document.getElementById('modalImageContainer');
  const image = localStorage.getItem("gcashImage");

  if (image) {
    container.innerHTML = `
      <img src="${image}" alt="GCash" style="max-width: 100%; max-height: 90vh; object-fit: contain;" />
    `;
  } else {
    container.textContent = "No GCash image uploaded yet.";
  }

  modal.style.display = "flex";
  modal.removeAttribute("inert");
  modal.setAttribute("aria-hidden", "false");

  const firstButton = modal.querySelector("button, [tabindex]:not([tabindex='-1'])");
  if (firstButton) firstButton.focus();
}

function closeModal() {
  const modal = document.getElementById('gcashModal');
  modal.style.display = "none";
  modal.setAttribute("inert", "");
  modal.setAttribute("aria-hidden", "true");

  if (lastFocusedElement) lastFocusedElement.focus();
}

// Close when clicking outside
window.addEventListener("click", (event) => {
  const modal = document.getElementById('gcashModal');
  if (event.target === modal) {
    closeModal();
  }
});

/* 🔹 Toggle receipt required */
document.querySelectorAll('input[name="addon"]').forEach(radio => {
  radio.addEventListener("change", () => {
    const receipt = document.getElementById("receiptInput");
    if (radio.value === "100 drinks" || radio.value === "500 drinks") {
      receipt.required = true;
    } else {
      receipt.required = false;
    }
  });
});

/* 🔹 Form Submission */
document.addEventListener('DOMContentLoaded', () => {
  const homeForm = document.getElementById('homecomingForm');
  if (!homeForm) return;

  homeForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();

    const fd = new FormData(homeForm);
    const addon = fd.get("addon");

    // 🔹 Case 1: Add-on = 100 or 500 but GCash is disabled → block
    if ((addon === "100" || addon === "500") && !gcashEnabled) {
      showToast("❌ Registration blocked: GCash payment method is currently disabled by admin.", "error");
      return;
    }

    // 🔹 Case 2: Add-on = 100 or 500, GCash enabled but no receipt uploaded → block
    if ((addon === "100" || addon === "500") && !fd.get("receipt")?.name) {
      showToast("❌ Receipt is required for selected add-on", "error");
      return;
    }

    // 🔹 Case 3: "No addon" OR valid receipt → allow registration
    try {
      const res = await fetch('/api/homeregs', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');

      closeHomecomingModal();
      homeForm.reset();
      showToast("🎉 Registration successful!", "success");

    } catch (err) {
      console.error(err);
      showToast("❌ " + err.message, "error");
    }
  });
});





/* 🔹 Ensure modals hidden & check GCash state (from localStorage) */
document.addEventListener("DOMContentLoaded", () => {
  const modals = document.querySelectorAll("#modal-home, #gcashModal");
  modals.forEach(modal => {
    modal.style.display = "none";
    modal.setAttribute("inert", "");
    modal.setAttribute("aria-hidden", "true");
  });

  // ✅ Get GCash enable/disable state from localStorage
  if (localStorage.getItem("gcashEnabled") === null) {
    localStorage.setItem("gcashEnabled", "true"); // default = enabled
  }

  gcashEnabled = localStorage.getItem("gcashEnabled") === "true";

  const gcashBtn = document.getElementById("gcashBtn");
  if (gcashBtn && !gcashEnabled) {
    gcashBtn.disabled = true;
    gcashBtn.classList.add("gcash-disabled");
  }
});





// 🔹 Open Sportfest Modal (with auto-filled location as sportType)
function openSportfestModal(post) {


  const modal = document.getElementById("sportfestModal");
  if (!modal) return;

  modal.style.display = "flex";
  modal.style.opacity = "1";
  modal.style.visibility = "visible";
  modal.removeAttribute("inert");
  modal.setAttribute("aria-hidden", "false");

  const sportTypeField = document.getElementById("sportTypeField");
  if (sportTypeField && post?.location) {
    sportTypeField.value = post.location;
  }

  const locationDisplay = document.getElementById("sportfestLocation");
  if (locationDisplay && post?.location) {
    locationDisplay.textContent = `🎉 Type of Event: ${post.location}`;
  }
}

function closeSportfestModal() {
  const modal = document.getElementById("sportfestModal");
  if (!modal) return;

  // ✅ Send focus back to body (or opener button if you store it)
  document.body.focus();

  modal.style.display = "none";
  modal.style.opacity = "0";
  modal.style.visibility = "hidden";
  modal.setAttribute("inert", "");
  modal.removeAttribute("aria-hidden");
}

// 🔹 Optional: Close when clicking outside
window.addEventListener("click", (e) => {
  const modal = document.getElementById("sportfestModal");
  if (modal && e.target === modal) {
    closeSportfestModal();
  }
});

// 🔹 Optional: Close with ESC key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeSportfestModal();
  }
});

/* 🔹 Sportfest Form Submission */
document.addEventListener("DOMContentLoaded", () => {
  const sportfestForm = document.getElementById("sportfestForm");
  const sportfestModal = document.getElementById("sportfestModal");
  const popup = document.getElementById("sportfestPopup");
  const dynamicFields = document.getElementById("dynamicFields");

  if (!sportfestForm) return;

  sportfestForm.addEventListener("submit", async (ev) => {
    ev.preventDefault();

    const data = new FormData(sportfestForm);

    const payload = {
      firstName: data.get("firstName")?.trim(),
      middleName: data.get("middleInitial")?.trim() || "",
      lastName: data.get("lastName")?.trim(),
      gender: data.get("sex")?.trim(),
      extension: data.get("extension")?.trim() || "",
      yearGraduated: data.get("batch")?.trim() || "",
      sportType: data.get("sportType")?.trim() || "" // ✅ auto-filled
    };

    // ✅ Validation
    if (!payload.firstName || !payload.lastName || !payload.gender || !payload.sportType) {
      return showToast("❌ Please complete all required fields.", "error");
    }

    try {
      const res = await fetch("/api/allsport/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if (!res.ok) throw new Error(json.error || res.status);

      // ✅ Choose emoji based on sportType (or location)
      let emoji = "🏐"; // Default
      const sport = payload.sportType.toLowerCase();

      if (sport.includes("chess")) emoji = "♟️";
      if (sport.includes("darts")) emoji = "🎯";
      if (sport.includes("volleyball")) emoji = "🏐";
      if (sport.includes("basketball")) emoji = "🏀";

      // ✅ Reset form + modal
      sportfestModal.style.display = "none";
      sportfestForm.reset();
      if (dynamicFields) dynamicFields.innerHTML = "";

      showToast("🎉 Sportfest registration successful!", "success");
    } catch (err) {
      console.error(err);
      showToast("❌ Error: " + err.message, "error");
    }
  });
});

// Fetch logged-in user info
fetch('/api/auth/me')
  .then(res => {
    if (!res.ok) throw new Error("Not logged in");
    return res.json();
  })
  .then(user => {
    document.getElementById('displayName').textContent =
      `${(user.firstName || "").toUpperCase()} ${(user.lastName || "").toUpperCase()}`;
  })
  .catch(() => {
    document.getElementById('displayName').textContent = "GUEST";
  });


</script>
</body>
</html>