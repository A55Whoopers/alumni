<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOME | TUP - Cavite</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;500;700&family=Albert+Sans:wght@400;500;700&family=Sanchez&display=swap" rel="stylesheet" />
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Font Awesome for Social Media Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <link rel="icon" type="image/png" href="/Logo2.png">


  <!-- External CSS -->
  <link rel="stylesheet" href="user-homepage.css" />
</head>
<body>
  <div class="userpage">
    <img class="Navbar" src="Navbar.png" />
    <div class="Line1"></div>
    <div class="Line2"></div>

    <!-- Career Button -->
    <div class="career-button slide-in" onclick="openCareerPopup()">
      <div class="content">
        <div class="state-layer">
          <div class="hover-underline1">CAREER</div>
        </div>
      </div>
    </div>
    <div id="notificationAlert" class="notification-modal">
      <div class="notification-box">
        <span id="closeNotification" class="notification-close">&times;</span>
        <div id="notificationMessage" class="notification-message"></div>
      </div>
    </div>


    <a href="user-eventpage.html" class="event-button slide-in" style="text-decoration: none; color: inherit;">
      <div class="content">
        <div class="state-layer">
          <div class="hover-underline1">EVENTS</div>
        </div>
      </div>
    </a>

    <!-- ID Request Button -->
    <div class="id-button slide-in" onclick="openIdRequestPopup()">
      <div class="content">
        <div class="state-layer">
          <div class="hover-underline1">ID REQUEST</div>
        </div>
      </div>
    </div>

    <!-- ID Request Modal -->
    <div id="idRequestPopup" class="ID-popup-overlay">
      <div class="ID-popup-content">
        <div class="navbar"></div>
        <img class="Logo3" src="Logo2.png" alt="TUPC Logo" />
        <div class="id-selection">ID REQUEST FORM</div>
          <span class="id-selection-span">ID Request</span>
          <span class="id-selection-span2">FORM</span>


            <form id="idRequestForm" enctype="multipart/form-data" onsubmit="event.preventDefault(); submitIdRequestForm();">
              <label>Upload Valid ID *</label>
              <input type="file" name="idImage" required>

              <label for="fullName">Full Name on Official Records *</label>
              <input 
                type="text" 
                name="fullName" 
                id="fullName" 
                required 
                maxlength="30" 
                oninput="this.value = formatName(this.value)"
              />

              <label for="degree">Course Major in. [BET-COET/BTVTED-ET] *</label>
              <input 
                type="text" 
                name="degree" 
                id="degree" 
                required 
                maxlength="9" 
                oninput="this.value = formatDegree(this.value)"
              />

              <label for="yearGraduated">Year Graduated *</label>
              <input 
                type="text" 
                name="yearGraduated" 
                id="yearGraduated" 
                required 
                maxlength="4" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />

              <label for="studentNo">Student No. *</label>
              <input 
                type="text" 
                name="studentNo" 
                id="studentNo" 
                required 
                maxlength="4" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />

              <label for="phoneNo">Phone No. *</label>
              <input 
                type="tel" 
                name="phoneNo" 
                id="phoneNo" 
                required 
                maxlength="12" 
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />

              <label for="email">Personal Email Address *</label>
              <input 
                type="email" 
                name="email" 
                id="email" 
                required 
                maxlength="40" 
                oninput="this.value = this.value.replace(/\s/g, '')"
              />
            </form>

        <div class="popup-buttons">
          <button class="id-btn1" onclick="submitIdRequestForm()">Submit</button>
          <button class="id-btn2" onclick="closeIdRequestPopup()">Close</button>
        </div>
      </div>
    </div>

    <div id="popupMessage" class="popup-message hidden">
      <span id="popupText"></span>
    </div>

    
    <div class="gallery-button slide-in" onclick="window.location.href='gallery-user.html?from=user-homepage.html'">
      <div class="content">
        <div class="state-layer">
          <div class="hover-underline1">GALLERY</div>
        </div>
      </div>
    </div>


    <button id="signOutBtn" class="sign-out-button slide-in">
      <div class="content"><div class="state-layer"><div class="hover-underline1">SIGN-OUT</div></div></div>
    </button>

    <div id="loader-wrapper">
      <div class="loader-content">
          <span class="loading-span">T</span>
          <span class="loading-span2">ECHNOLOGICAL</span>
          <span class="loading-span">U</span>
          <span class="loading-span2">NIVERSITY OF THE</span>
          <span class="loading-span">P</span>
          <span class="loading-span2">HILIPPINES - </span>
          <span class="loading-span">C</span>
          <span class="loading-span2">AVITE</span>

        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="percentage" id="percentage">0%</div>
        <div class="footer-text">LOADING PLEASE WAIT</div>
      </div>
    </div>


    <a href="user-homepage.html">
      <img class="Logo" src="Logo.png" alt="University Logo" />
    </a>

    <div class="a-l-u-m-n-i slide-in">
      <span class="a-l-u-m-n-i-span">A</span>
      <span class="a-l-u-m-n-i-span2">l u m n i</span>
      <span class="a-l-u-m-n-i-span">U</span>
      <span class="a-l-u-m-n-i-span2">s e r</span>
    </div>

    <div class="technological-university-of-the-philippines-cavite">
      TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES ‚Äì CAVITE
    </div>


    <div class="announcement-box">
      <h3>ID Announcements</h3>
      <div class="announcement-list" id="idAnnouncementList">
        Loading...
      </div>
    </div>

    <div class="announcement-box2">
      <h3>Events Announcements</h3>
      <div class="announcement-list" id="eventList">
        Loading...
      </div>
    </div>

    <div class="career-box">
      <h3>Career Opportunities</h3>
      <div class="career-list" id="careerList">
        Loading...
      </div>
    </div>





<!-- Profile picture trigger -->
<img id="profilePic" src="default-profile.png" alt="Profile Picture" class="profile-circle" onclick="openProfileModal()">

<!-- Modal -->
<div id="modal-profile" class="modal-profile">
  <div class="modal-profile-content">
    <!-- Close Button -->
    <button class="modal-profile-close" onclick="closeProfileModal()">&times;</button>
    
    <!-- Profile Header -->
    <div class="modal-top">
      <img 
        id="modalProfilePic" 
        src="default-profile.png" 
        alt="Profile" 
        class="modal-profile-pic"
      >
      <h2 id="name">Loading...</h2>
    </div>
    
    <!-- Profile Details -->
    <div class="modal-details">
      <p><strong>Username:</strong> <span id="userName">-</span></p>

      <!-- Email -->
      <p>
        <strong>Email:</strong>
        <span id="personalEmail">-</span>
        <input type="email" id="editPersonalEmail" style="display:none;">
      </p>

      <!-- Civil Status -->
      <p>
        <strong>Civil Status:</strong>
        <span id="civilStatus">-</span>
        <input type="text" id="editCivilStatus" style="display:none;">
      </p>

      <!-- Phone No -->
      <p>
        <strong>Phone No.:</strong>
        <span id="phoneNo">-</span>
        <input type="text" id="editPhoneNo" style="display:none;">
      </p>

      <!-- Read-only fields -->
      <p><strong>Gender:</strong> <span id="gender">-</span></p>
      <p><strong>Date of Birth:</strong> <span id="dateBirth">-</span></p>
      <p><strong>Major:</strong> <span id="major">-</span></p>
      <p><strong>Year Started:</strong> <span id="yearStarted">-</span></p>
      <p><strong>Graduated:</strong> <span id="graduated">-</span></p>
      <p><strong>Student No.:</strong> <span id="studentNo">-</span></p>
    </div>

    <!-- Actions -->
    <div class="modal-actions">
      <button id="editBtn" onclick="enableEdit()">Edit</button>
      <button id="saveBtn" style="display:none;" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<div id="feed"></div>

<!-- Toast Notification -->
<div id="toast"></div>

<div id="mensBasketballModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeMensBasketballModal()">&times;</span>
    <h2>üèÄ Men's Basketball Registration</h2>
    <form id="mensBasketballForm">
      
      <!-- ‚úÖ Team Name -->
      <label for="teamName">Team Name</label>
      <input 
        type="text" 
        id="teamName" 
        name="teamName" 
        maxlength="20" 
        required 
        placeholder="Enter Team Name"
        oninput="validateTeamName(this)"
      />

      <!-- ‚úÖ Age Range -->
      <label for="ageRange">Age Range</label>
      <input 
        type="text" 
        id="ageRange" 
        name="ageRange" 
        maxlength="5" 
        required 
        placeholder="e.g. 18-25"
        oninput="validateAgeRange(this)"
      >

      <!-- ‚úÖ Members -->
      <div id="membersContainer">
      <div class="member">
        <input 
          type="text" 
          name="firstName[]" 
          placeholder="First Name" 
          maxlength="20" 
          required
          oninput="validateName(this)"
        >
        <input 
          type="text" 
          name="middleInitial[]" 
          placeholder="M.I." 
          maxlength="1"
          oninput="validateMiddleInitial(this)"
        >
        <input 
          type="text" 
          name="lastName[]" 
          placeholder="Last Name" 
          maxlength="20" 
          required
          oninput="validateName(this)"
        >
      </div>
    </div>

      <button type="button" class="add-member-btn" onclick="addMember()">+ Add Member</button>
      <button type="submit">Register</button>
    </form>
  </div>
</div>



<!-- Career Survey Modal -->
<div id="careerSurveyModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeCareerSurvey()">&times;</span>
    <h2>Career Survey</h2>
    <form id="careerSurveyForm">
      <div id="surveyQuestions"></div>
      <button type="submit" class="submit-btn">Submit Survey</button>
    </form>
  </div>
</div>

<!-- Employment Application Modal -->
<div id="employmentFormModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeEmploymentForm()">&times;</span>
    <h2>Employment Application</h2>
    <form id="employmentForm" enctype="multipart/form-data">
      <label>First Name</label>
      <input type="text" name="firstName" required />

      <label>Last Name</label>
      <input type="text" name="lastName" required />

      <label>Phone Number</label>
      <input type="tel" name="phone" required />

      <label>Email</label>
      <input type="email" name="email" required />

      <label>Upload Resume (PDF)</label>
      <input type="file" name="resume" accept="application/pdf" required />

      <button type="submit" class="submit-btn">Submit Application</button>
    </form>
  </div>
</div>


<!-- Survey Notification -->
<div id="surveyNotification" class="survey-notification">
  <span id="surveyNotificationMsg"></span>
  <button class="survey-close-btn" onclick="closeSurveyNotification()">√ó</button>
</div>


<script type="module">
  import { setupSignOut } from './sign-out.js';
  setupSignOut('user');

  async function loadIdAnnouncements() {
    const container = document.getElementById('idAnnouncementList');
    container.innerHTML = 'Loading...';

    try {
      const res = await fetch('/api/admin/id-announcements');
      if (!res.ok) throw new Error('Failed to load ID announcements');
      const { announcements } = await res.json();

      container.innerHTML = announcements.map(a => `
        <div class="event-card">
          <div class="event-header">
            <span class="badge">ID ANNOUNCEMENT</span>
            <span class="posted-date">Posted: ${new Date(a.datePosted).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
          </div>
          <div class="event-title">${a.title}</div>
          <p>${a.description}</p>
        </div>
      `).join('') || '<div>No announcements found.</div>';

    } catch (err) {
      container.innerHTML = `<div class="error">‚ùå Failed to load announcements</div>`;
      console.error(err);
    }
  }

  document.addEventListener('DOMContentLoaded', loadIdAnnouncements);

  async function loadEvents() {
    const container = document.getElementById('eventList');
    container.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/events');
      if (!res.ok) throw new Error('Failed to load events');
      const { events } = await res.json();

      container.innerHTML = events.map(e => `
        <div class="event-card">
          <div class="event-header">
            <span class="badge">EVENT ANNOUNCEMENT</span>
            <span class="posted-date">Posted: ${new Date(e.datePosted).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
          </div>
          <div class="event-title">${e.title}</div>
        </div>
      `).join('') || '<div>No announcements found.</div>';

    } catch (err) {
      container.innerHTML = `<div class="error">‚ùå Failed to load announcements</div>`;
      console.error(err);
    }
  }

  document.addEventListener('DOMContentLoaded', loadEvents);

  async function loadCareers() {
    const listContainer = document.getElementById('careerList');
    listContainer.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/careers');
      if (!res.ok) throw new Error('Failed to load careers');
      const { careers } = await res.json();
      listContainer.innerHTML = careers.slice(0, 10).map(career => `
        <div class="career-card">
          <div class="career-header">
            <span class="career-badge">CAREER</span>
            Posted: ${new Date(career.datePosted).toLocaleDateString()}
          </div>
          <div class="career-title">${career.title}</div>
        </div>
      `).join('') || '<div>No announcements found.</div>';
    } catch (err) {
      listContainer.innerHTML = '‚ùå Failed to load careers';
    }
  }

  document.addEventListener('DOMContentLoaded', loadCareers);

  window.addEventListener('DOMContentLoaded', () => {
    const role = sessionStorage.getItem('userRole');
    if (!role) {
      window.location.href = 'homepage.html';
    } else if (role === 'admin') {
      window.location.href = 'admin-homepage.html';
    } else {
      loadIdAnnouncements();  // ‚úÖ Correct function call!
    }
  });
</script>

  <!-- Modal Script -->
<script>
  function formatDegree(value) {
    // Allow only letters and dashes, remove others
    value = value.replace(/[^a-zA-Z\-]/g, '');

    // Only allow first dash
    const firstDash = value.indexOf('-');
    if (firstDash !== -1) {
      value = value.substring(0, firstDash + 1) + value.substring(firstDash + 1).replace(/\-/g, '');
    }

    // Convert to uppercase
    return value.toUpperCase();
  }
  function formatName(value) {
    // Remove numbers and special characters, keep letters and spaces
    value = value.replace(/[^a-zA-Z\s]/g, '');

    // Capitalize the first letter of each word
    return value.replace(/\b\w/g, char => char.toUpperCase());
  }


// Loading Screen Script
document.addEventListener("DOMContentLoaded", () => {
let percentage = 80;
const loaderWrapper = document.getElementById("loader-wrapper");
const progressBar = document.getElementById("progress-bar");
const percentageText = document.getElementById("percentage");

const loadingInterval = setInterval(() => {
  if (percentage < 100) {
    percentage++;
        progressBar.style.width = percentage + "%";
        percentageText.textContent = percentage + "%";
      } else {
        clearInterval(loadingInterval);
        loaderWrapper.style.display = "none";
      }
    }, 30);
  });

  // Facebook SDK Initialization
  window.fbAsyncInit = function () {
    FB.init({
      xfbml: true,
      version: 'v17.0'
    });
  };

  (function (d, s, id) {
    if (d.getElementById(id)) return;
    let js = d.createElement(s);
    js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    d.head.appendChild(js);
  }(document, 'script', 'facebook-jssdk'));

  // Career Popup Script
  document.addEventListener("DOMContentLoaded", () => {
    // Open popup
    window.openCareerPopup = function () {
      document.getElementById('careerPopup').style.display = 'block';
    };

    // Close popup and clear the form
    window.closeCareerPopup = function () {
      document.getElementById('careerPopup').style.display = 'none';

      // Clear the form inputs
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('interested').selectedIndex = 0;
      document.getElementById('employmentStatus').selectedIndex = 0;
    };
  });

  function submitCareerForm() {
    const payload = {
      firstName: document.getElementById('firstName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      interested: document.getElementById('interested').value,
      employmentStatus: document.getElementById('employmentStatus').value
    };

    fetch('/api/responses/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(async res => {
      const text = await res.text();
      console.debug('Response status:', res.status);
      console.debug('Response body:', text);
      if (!res.ok) throw new Error(text);
      return JSON.parse(text);
    })
    .then(data => {
      showNotification(`‚úÖ Submission successful!`);
      setTimeout(() => {
        window.location.href = 'career-post.html';
      }, 3000);
    })
    .catch(err => {
      console.error('Submission failed:', err);
      showNotification(`Please fill up all the requirment`);
    });
  }

  function showNotification(message) {
    const popup = document.getElementById('notificationAlert');
    const msg = document.getElementById('notificationMessage');
    msg.textContent = message;
    popup.style.display = 'flex';

    setTimeout(() => {
      popup.style.display = 'none';
    }, 3000);
  }

  document.getElementById('closeNotification').onclick = () => {
    document.getElementById('notificationAlert').style.display = 'none';
  };

  document.addEventListener("DOMContentLoaded", () => {
    const galleryBtn = document.getElementById('galleryBtn');
    if (galleryBtn) {
      galleryBtn.onclick = () => {
        window.location.href = 'gallery-user.html?from=user-homepage.html';
      };
    }
  });

// Open the ID Request Popup
function openIdRequestPopup() {
  document.getElementById('idRequestPopup').style.display = 'flex';
}

// Close and Clear the Form using Form Reset
function closeIdRequestPopup() {
  const form = document.getElementById('idRequestForm');
  if (form) form.reset();  // ‚úÖ Reset all form fields at once

  document.getElementById('idRequestPopup').style.display = 'none';
}

function submitIdRequestForm() {
  const formElement = document.getElementById('idRequestForm');
  const formData = new FormData(formElement);

  fetch('/api/requests/add', {
    method: 'POST',
    body: formData
  })
  .then(async res => {
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Unknown error');
    showPopup('‚úÖ Submission Successful!');
    closeIdRequestPopup();
  })
  .catch(err => {
    showPopup('‚ùå Submission failed: ' + err.message, true);
  });
}

function showPopup(message, isError = false) {
  const popup = document.getElementById('popupMessage');
  const popupText = document.getElementById('popupText');

  popupText.textContent = message;
  popup.classList.remove('error', 'show');
  if (isError) popup.classList.add('error');
  
  // Force reflow for animation reset
  void popup.offsetWidth; 
  popup.classList.add('show');

  // Hide after 3 seconds
  setTimeout(() => popup.classList.remove('show'), 3000);
}


function showEmployerToast(message, type = 'success') {
  const toast = document.getElementById('employer-toast');
  const toastMsg = document.getElementById('employer-toast-msg');
  toastMsg.textContent = message;

  toast.className = `employer-toast show ${type}`;
  setTimeout(() => {
    toast.className = 'employer-toast';
  }, 3000);
}

function showLoginToast(message, type = 'success') {
  const toast = document.getElementById('login-toast');
  const toastMsg = document.getElementById('login-toast-message');
  toastMsg.textContent = message;
  toast.className = `toast show ${type}`;

  setTimeout(() => {
    toast.className = 'toast';  // Hide after 3 seconds
  }, 3000);
}


/////////////////////////////////////////////////////////////////////////////////////


function openProfileModal() {
  const modal = document.getElementById("modal-profile");
  const profilePic = document.getElementById("profilePic");
  const modalProfilePic = document.getElementById("modalProfilePic");

  if (modal && profilePic && modalProfilePic) {
    modal.style.display = "flex";
    modalProfilePic.src = profilePic.src;
  }

  // Show loading state
  document.getElementById('name').textContent = "Loading...";

  // ‚úÖ Fetch user full information instead of only registration
  fetch('/api/fullInformation/me', { credentials: 'include' })
    .then(res => {
      if (!res.ok) throw new Error("Not logged in or no user info found");
      return res.json();
    })
    .then(data => {
      document.getElementById('name').textContent = 
        [data.firstName, data.lastName].filter(Boolean).join(" ") || "No Name";

      document.getElementById('userName').textContent = data.userName || '-';
      document.getElementById('personalEmail').textContent = data.personalEmail || '-';
      document.getElementById('gender').textContent = data.gender || '-';

      // extra info from fullInformation
      document.getElementById('civilStatus').textContent = data.civilStatus || '-';
      document.getElementById('dateBirth').textContent = data.dateBirth 
        ? new Date(data.dateBirth).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })
        : '-';
      document.getElementById('phoneNo').textContent = data.phoneNo || '-';
      document.getElementById('major').textContent = data.major || '-';
      document.getElementById('yearStarted').textContent = data.yearStarted || '-';
      document.getElementById('graduated').textContent = data.graduated || '-';
      document.getElementById('studentNo').textContent = data.studentNo || '-';
    })
    .catch(err => {
      console.error('‚ùå Error loading user info:', err);
      document.getElementById('name').textContent = "Error loading info";
    });
}

function closeProfileModal() {
  document.getElementById("modal-profile").style.display = "none";
}

function enableEdit() {
  // Email
  document.getElementById("personalEmail").style.display = "none";
  document.getElementById("editPersonalEmail").style.display = "inline";
  document.getElementById("editPersonalEmail").value = document.getElementById("personalEmail").textContent;

  // Civil Status
  document.getElementById("civilStatus").style.display = "none";
  document.getElementById("editCivilStatus").style.display = "inline";
  document.getElementById("editCivilStatus").value = document.getElementById("civilStatus").textContent;

  // Phone No
  document.getElementById("phoneNo").style.display = "none";
  document.getElementById("editPhoneNo").style.display = "inline";
  document.getElementById("editPhoneNo").value = document.getElementById("phoneNo").textContent;

  // Switch buttons
  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "inline";
}

function saveProfile() {
  const updatedData = {
    personalEmail: document.getElementById("editPersonalEmail").value,
    civilStatus: document.getElementById("editCivilStatus").value,
    phoneNo: document.getElementById("editPhoneNo").value
  };

  fetch("/api/registration/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(updatedData)
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("Profile updated!");

        // Update UI
        document.getElementById("personalEmail").textContent = updatedData.personalEmail;
        document.getElementById("civilStatus").textContent = updatedData.civilStatus;
        document.getElementById("phoneNo").textContent = updatedData.phoneNo;

        // Switch back to view mode
        document.getElementById("personalEmail").style.display = "inline";
        document.getElementById("civilStatus").style.display = "inline";
        document.getElementById("phoneNo").style.display = "inline";

        document.getElementById("editPersonalEmail").style.display = "none";
        document.getElementById("editCivilStatus").style.display = "none";
        document.getElementById("editPhoneNo").style.display = "none";

        document.getElementById("editBtn").style.display = "inline";
        document.getElementById("saveBtn").style.display = "none";
      } else {
        showToast("Error: " + data.error, true);
      }
    })
    .catch(err => {
      console.error("‚ùå Update error:", err);
      showToast("Server error while updating", true);
    });
}



function showToast(message, isError = false) {
  const toast = document.getElementById("toast");
  toast.textContent = message;

  toast.style.backgroundColor = isError ? "#d9534f" : "#28a745";
  toast.className = "show";

  setTimeout(() => {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}







async function loadFeed() {
  const container = document.getElementById('feed');
  container.innerHTML = 'Loading feed...';

  // helper: normalize title to a canonical key (uppercase, remove spaces & punctuation)
  function normalizeTitle(t = '') {
    return String(t).toUpperCase().replace(/[\s'".,()-]/g, '').replace(/[^A-Z0-9]/g, '');
  }

  // safe HTML escape for attributes
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // map normalized title keys => modal openers (strings for function names)
  const registrationMap = {
    'MENSBASKETBALL': 'openMensBasketballModal',
    'MENSBASKETBALLEVENT': 'openMensBasketballModal', // if some variants saved this way
    'HOMECOMINGEVENT': 'openHomecomingModal',
    'HOMECOMING': 'openHomecomingModal',
    'SPORTFEST': 'openSportfestModal',
    'SPORTFESTEVENT': 'openSportfestModal',
    'CAREER': 'openCareerModal',
    'CAREERPOSTING': 'openCareerModal'
  };

  try {
    // fetch events/careers
    const [eventsRes, careersRes] = await Promise.all([
      fetch('/api/events'),
      fetch('/api/careers')
    ]);

    if (!eventsRes.ok || !careersRes.ok) {
      // throw explicit message to hit your catch and show "Failed to load feed"
      throw new Error('Failed to fetch events or careers (check server).');
    }

    const { events } = await eventsRes.json();
    const { careers } = await careersRes.json();

    const formattedEvents = events.map(e => ({ ...e, type: 'Event' }));
    const formattedCareers = careers.map(c => ({ ...c, type: 'Career' }));

    const feed = [...formattedEvents, ...formattedCareers]
      .sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));

    // render
    container.innerHTML = feed.map((post, index) => {
      const title = post.title || '';
      const norm = normalizeTitle(title);
      const showRegister = post.type === "Career" || Boolean(registrationMap[norm]);


      const extraInfo = post.type === 'Event'
        ? `üéâ Event: ${post.location || "N/A"}`
        : `üè¢ Company Name: ${post.link || "N/A"}`;

      // escape attributes
      const escapedTitleAttr = escapeHtml(title);
      const isoDate = new Date(post.datePosted).toISOString();

      return `
        <div class="feed-card">
          ${post.image ? `<img class="feed-img" src="${post.image}" alt="">` : ""}
          <div class="feed-content">
            <h2>${(title || '').toUpperCase()} <small>[${post.type}]</small></h2>
            <p>${post.description || ''}</p>
            <small>
              ${extraInfo} <br>
              üïí Posted on: ${new Date(post.datePosted).toLocaleString()} <br>
              ‚è≥ <span class="countdown" data-time="${isoDate}" id="countdown-${index}"></span>
            </small>
              ${ showRegister
                ? `<button class="register-btn" 
                            data-id="${post.id}" 
                            data-type="${post.type}" 
                            data-title="${escapedTitleAttr}" 
                            data-norm="${norm}">
                    ${post.type === "Career" ? "Apply" : "Register"}
                  </button>`
                : ""
              }
          </div>
        </div>
      `;
    }).join('');

    // delegation: handle register button clicks (safe ‚Äî no inline onclick)
    container.addEventListener('click', function onFeedClick(e) {
      const btn = e.target.closest && e.target.closest('.register-btn');
      if (!btn) return;

      const title = btn.getAttribute('data-title') || '';
      const norm = btn.getAttribute('data-norm') || normalizeTitle(title);
      const type = btn.getAttribute('data-type');  // ‚úÖ FIX: added
      const id = btn.getAttribute('data-id');      // ‚úÖ FIX: added

      // üöÄ Handle career apply
      if (type === "Career" && typeof window.openCareerSurvey === "function") {
        window.openCareerSurvey({
          id,
          title,
          description: btn.closest(".feed-card").querySelector("p")?.textContent || ""
        });
        return;
      }

      // ‚úÖ Handle events normally
      const fnName = registrationMap[norm];
      if (fnName && typeof window[fnName] === 'function') {
        window[fnName](title);
      } else if (typeof window.openRegistrationModal === 'function') {
        window.openRegistrationModal(title);
      } else {
        console.warn('No modal opener found for', title, norm);
        alert('Registration not available for this post.');
      }
    }, { once: false });




    // countdowns
    function updateCountdowns() {
      document.querySelectorAll(".countdown").forEach(el => {
        const postedTime = new Date(el.dataset.time);
        const expireTime = new Date(postedTime.getTime() + 24 * 60 * 60 * 1000); // 1 day expiration
        const now = new Date();
        const diffMs = expireTime - now;

        if (diffMs <= 0) {
          el.textContent = "‚ùå Expired";
          return;
        }

        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);

        el.textContent = `${hours}h ${minutes}m ${seconds}s left`;
      });
    }

    updateCountdowns();
    setInterval(updateCountdowns, 1000);

  } catch (err) {
    console.error(err);
    container.textContent = '‚ö†Ô∏è Failed to load feed.';
  }
}

document.addEventListener('DOMContentLoaded', loadFeed);








// üîπ Master modal opener
function openRegistrationModal(title) {
  switch (title.toUpperCase()) {
    case "MENSBASKETBALL":
      openMensBasketballModal();
      break;

    case "HOMECOMING EVENT":
      openHomecomingModal();
      break;

    case "SPORTFEST":
      openSportfestModal();
      break;

    case "CAREER FAIR":
      openCareerModal();
      break;

    default:
      console.warn("‚ö†Ô∏è No modal opener found for", title);
  }
}

// üîπ Men‚Äôs Basketball modal handlers
function openMensBasketballModal() {
  document.getElementById("mensBasketballModal").style.display = "flex";
}

function closeMensBasketballModal() {
  document.getElementById("mensBasketballModal").style.display = "none";
}

function addMember() {
  const container = document.getElementById("membersContainer");
  const div = document.createElement("div");
  div.classList.add("member");
  div.innerHTML = `
    <input type="text" name="firstName[]" placeholder="First Name" required>
    <input type="text" name="middleInitial[]" placeholder="M.I.">
    <input type="text" name="lastName[]" placeholder="Last Name" required>
  `;
  container.appendChild(div);
}

// üîπ Handle Men‚Äôs Basketball form submission
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("mensBasketballForm");
  if (!form) return; // prevent null error

  form.onsubmit = async (e) => {
    e.preventDefault();

    const teamName = document.getElementById("teamName").value.trim();
    const ageRange = document.getElementById("ageRange").value.trim();

    // Collect all players
    const firstNames = document.querySelectorAll("input[name='firstName[]']");
    const middleInitials = document.querySelectorAll("input[name='middleInitial[]']");
    const lastNames = document.querySelectorAll("input[name='lastName[]']");

    const players = [];
    firstNames.forEach((input, i) => {
      players.push({
        firstName: input.value.trim(),
        middleInitial: middleInitials[i].value.trim(),
        lastName: lastNames[i].value.trim()
      });
    });

    const payload = { teamName, ageRange, players };

    try {
      const res = await fetch("/api/sportfest/mensBasketball", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to register");

      alert(`‚úÖ Team registered successfully! Players: ${data.playerCount}`);
      closeMensBasketballModal();
    } catch (err) {
      alert("‚ùå Error: " + err.message);
    }
  };
});









function openCareerSurvey(career) {
  window.currentCareer = career; // ‚úÖ keep career reference

  // Inject Survey Questions
  const modal = document.getElementById("careerSurveyModal");
  const container = document.getElementById("surveyQuestions");
  container.innerHTML = `
    <label>First Name</label>
    <input type="text" name="firstName" maxlength="20" required />

    <label>Last Name</label>
    <input type="text" name="lastName" maxlength="20" required />

    <label>Are you interested?</label>
    <select name="interested" required>
      <option value="">-- Select --</option>
      <option value="YES">YES</option>
      <option value="NO">NO</option>
    </select>

    <label>What is your current employment status?</label>
    <select name="employmentStatus" required>
      <option value="">-- Select --</option>
      <option value="EMPLOYED">EMPLOYED</option>
      <option value="UNEMPLOYED">UNEMPLOYED</option>
      <option value="UNDEREMPLOYED">UNDEREMPLOYED</option>
    </select>

    <label>If employed, is your work inline with this career?</label>
    <select name="inlineWork">
      <option value="">-- Select --</option>
      <option value="YES">YES</option>
      <option value="NO">NO</option>
      <option value="MAYBE">MAYBE</option>
    </select>
  `;

  modal.style.display = "flex";

  // ‚úÖ Survey Submit
  document.getElementById("careerSurveyForm").onsubmit = async function (e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    const payload = {
      careerId: career.id,
      firstName: formData.get("firstName"),
      lastName: formData.get("lastName"),
      interested: formData.get("interested"),
      employmentStatus: formData.get("employmentStatus"),
      inlineWork: formData.get("inlineWork") || null,
    };

    try {
      const res = await fetch("/api/responses/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to save survey");

      closeCareerSurvey();

      if (payload.interested === "NO") {
        showSurveyNotification("‚ùå You are not interested. Career description will not be shown.", "error");
      } else {
        // ‚úÖ If interested, open Employment Form
        document.getElementById("employmentFormModal").style.display = "flex";
      }
    } catch (err) {
      console.error("‚ùå Survey submit error:", err);
      showSurveyNotification("‚ùå Failed to save your survey. Please try again.", "error");
    }
  };

  // ‚úÖ Employment Application Submit
  document.getElementById("employmentForm").onsubmit = async function (e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
      const res = await fetch("/api/applications/add", {
        method: "POST",
        body: formData, // includes file
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to submit application");

      showSurveyNotification("‚úÖ Employment Application Submitted Successfully!", "success");
      closeEmploymentForm();
    } catch (err) {
      console.error("‚ùå Application submit error:", err);
      showSurveyNotification("‚ùå Failed to submit application. Please try again.", "error");
    }
  };
}

function closeCareerSurvey() {
  document.getElementById("careerSurveyModal").style.display = "none";
}

function closeEmploymentForm() {
  document.getElementById("employmentFormModal").style.display = "none";
}

function showSurveyNotification(message, type = "success") {
  const box = document.getElementById("surveyNotification");
  const msg = document.getElementById("surveyNotificationMsg");

  msg.innerHTML = message;
  box.className = `survey-notification ${type}`;
  box.style.display = "flex";
}

function closeSurveyNotification() {
  document.getElementById("surveyNotification").style.display = "none";
}







function validateAgeRange(input) {
  // Allow only numbers
  input.value = input.value.replace(/[^0-9]/g, "");

  // Limit to 5 digits
  if (input.value.length > 5) {
    input.value = input.value.slice(0, 5);
  }
}
function validateName(input) {
  // Remove non-letters
  input.value = input.value.replace(/[^a-zA-Z ]/g, "");

  // Capitalize first letter of each word
  input.value = input.value.replace(/\b\w/g, char => char.toUpperCase());
}

function validateMiddleInitial(input) {
  // Allow only 1 uppercase letter
  input.value = input.value.replace(/[^A-Za-z]/g, "").toUpperCase().slice(0, 1);
}
</script>
</body>
</html>