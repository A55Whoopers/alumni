<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALUMNI LIST | TUP - Cavite</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;500;700&family=Albert+Sans:wght@400;500;700&family=Sanchez&display=swap" rel="stylesheet" />
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Font Awesome for Social Media Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <link rel="icon" type="image/png" href="/Logo2.png">


  <link rel="stylesheet" href="admin-employer.css" />
</head>
<body>
  <div class="employerpage">
    <img class="Navbar" src="Navbar.png" />
    <div class="Line1"></div>
    <div class="label1">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES ‚Äì CAVITE</div>
    
    <a href="admin-homepage.html"><img class="Logo" src="Logo.png" alt="University Logo" /></a>
    <button class="back-button" onclick="location.href='admin-homepage.html'"><span class="underline-slide">‚Üê</span></button>
    
    <div class="a-l-u-m-n-i slide-in">
      <span class="a-l-u-m-n-i-span">E</span>
      <span class="a-l-u-m-n-i-span2">MPLOYER</span>
      <span class="d-a-t-a-b-a-s-e-span">R</span>
      <span class="d-a-t-a-b-a-s-e-span2">EGISTRATION</span>
    </div>

    <div id="loader-wrapper">
      <div class="loader-content">
          <span class="loading-span">T</span>
          <span class="loading-span2">ECHNOLOGICAL</span>
          <span class="loading-span">U</span>
          <span class="loading-span2">NIVERSITY OF THE</span>
          <span class="loading-span">P</span>
          <span class="loading-span2">HILIPPINES - </span>
          <span class="loading-span">C</span>
          <span class="loading-span2">AVITE</span>

        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="percentage" id="percentage">0%</div>
        <div class="footer-text">LOADING PLEASE WAIT</div>
      </div>
    </div>


    <!-- Info Modal -->
<div id="modalOverlay"></div>
<div id="infoModal">
  <span class="close-btn">&times;</span>
  <h3 id="modalTitle"></h3>
  <p id="modalContent"></p>
</div>

    <h2>Employer Registration List</h2>
<table id="employerTable">
  <thead>
    <tr>
      <th>Profile Picture</th> <!-- üëà new -->
      <th>Employer Name</th>
      <th>Business Name</th>
      <th>Business Address</th>
      <th>Landline No</th>
      <th>Mobile No</th>
      <th>Company Email</th>
      <th>Website</th>
      <th>User ID</th>
      <th>Status</th>
      <th>Submitted At</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

    <select id="statusFilter">
        <option value="ALL">All Statuses</option>
        <option value="PENDING">Pending</option>
        <option value="ACCEPTED">Accepted</option>
        <option value="ARCHIVED">Archived</option>
    </select>

    <select id="pageSelect"></select>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody       = document.querySelector('#employerTable tbody');
  const pageSelect  = document.getElementById('pageSelect');
  const statusFilter = document.getElementById('statusFilter');

  const ROWS_PER_PAGE = 100;
  let currentPage = 1;
  let totalPages  = 1;
  let allEmployers = [];

  if (sessionStorage.getItem('userRole') !== 'admin') {
    window.location.href = 'homepage.html';
    return;
  }

  // ‚úÖ Modal references
  const modalOverlay = document.getElementById("modalOverlay");
  const infoModal    = document.getElementById("infoModal");
  const modalTitle   = document.getElementById("modalTitle");
  const modalContent = document.getElementById("modalContent");
  const modalClose   = document.querySelector("#infoModal .close-btn");

  // ‚úÖ Helper: open/close modal
  function openInfoModal(label, value) {
    modalTitle.textContent = label;
    modalContent.textContent = value || "N/A";
    modalOverlay.style.display = "block";
    infoModal.style.display = "block";
  }
  function closeInfoModal() {
    modalOverlay.style.display = "none";
    infoModal.style.display = "none";
  }
  modalClose.addEventListener("click", closeInfoModal);
  modalOverlay.addEventListener("click", closeInfoModal);

  // ‚úÖ Helper: Create a "View" button cell
  function makeViewButtonCell(label, value) {
    const td = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "View";
    btn.addEventListener("click", () => openInfoModal(label, value));
    td.appendChild(btn);
    return td;
  }

  // Filter change
  statusFilter.addEventListener('change', () => loadPage(1));
  pageSelect.addEventListener('change', () => loadPage(+pageSelect.value));

  // Format date
  function formatDateForDisplay(dateValue) {
    if (!dateValue) return '';
    try {
      const date = new Date(dateValue);
      if (isNaN(date.getTime())) return dateValue;
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch {
      return dateValue;
    }
  }

  async function loadPage(page = 1) {
    currentPage = page;
    tbody.innerHTML = `<tr><td colspan="12">‚è≥ Loading...</td></tr>`;

    try {
      const res = await fetch('/api/employer/list');
      if (!res.ok) throw new Error(await res.text());
      const { employers } = await res.json();
      allEmployers = employers || [];

      // ‚úÖ Filter + Sort
      const statusPriority = { 'PENDING': 1, 'ACCEPTED': 2, 'ARCHIVED': 3 };
      const filterVal = statusFilter.value || 'ALL';

      const sortedEmployers = allEmployers
        .filter(emp => {
          const st = emp.status?.toUpperCase() || 'PENDING';
          return filterVal === 'ALL' || st === filterVal;
        })
        .sort((a, b) => {
          const sa = statusPriority[a.status?.toUpperCase() || 'PENDING'] || 99;
          const sb = statusPriority[b.status?.toUpperCase() || 'PENDING'] || 99;
          return sa !== sb
            ? sa - sb
            : new Date(b.submittedAt) - new Date(a.submittedAt);
        });

      totalPages = Math.ceil(sortedEmployers.length / ROWS_PER_PAGE);
      buildPagination();

      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const paginated = sortedEmployers.slice(start, start + ROWS_PER_PAGE);

      tbody.innerHTML = '';
      paginated.forEach(emp => {
        const tr = document.createElement('tr');
        const currentStatus = emp.status?.toUpperCase() || 'PENDING';

        // ‚úÖ Profile Picture
        const tdPic = document.createElement('td');
        if (emp.companyLogo) {
          const img = document.createElement("img");
          img.src = emp.companyLogo.startsWith('/')
            ? emp.companyLogo
            : '/uploads/companyLogos/' + emp.companyLogo;
          img.alt = "Company Logo";
          img.style.width = "40px";
          img.style.height = "40px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "50%";
          img.style.cursor = "pointer";
          img.addEventListener("click", () => {
            window.open(img.src, "_blank");
          });
          tdPic.appendChild(img);
        } else {
          tdPic.textContent = "No Picture";
        }
        tr.appendChild(tdPic);

        // ‚úÖ Employer Name (show text directly)
        const tdName = document.createElement('td');
        tdName.textContent = emp.employerName || '';
        tr.appendChild(tdName);

        // ‚úÖ Replace long fields with View button
        tr.appendChild(makeViewButtonCell("Business Name", emp.businessName));
        tr.appendChild(makeViewButtonCell("Business Address", emp.businessAddress));
        tr.appendChild(makeViewButtonCell("Landline", emp.landlineNo));
        tr.appendChild(makeViewButtonCell("Mobile", emp.mobileNo));
        tr.appendChild(makeViewButtonCell("Company Email", emp.companyEmail));
        tr.appendChild(makeViewButtonCell("Website", emp.companyWebsite));

        // ‚úÖ User ID
        const tdUser = document.createElement('td');
        tdUser.textContent = emp.preferredUserId || '';
        tr.appendChild(tdUser);

        // ‚úÖ Status
        const tdStatus = document.createElement('td');
        tdStatus.textContent = currentStatus;
        tdStatus.className = `status ${currentStatus}`;
        tr.appendChild(tdStatus);

        // ‚úÖ Submitted Date
        const tdDate = document.createElement('td');
        tdDate.textContent = formatDateForDisplay(emp.submittedAt);
        tr.appendChild(tdDate);

        // ‚úÖ Actions
        const tdAction = document.createElement('td');
        tdAction.innerHTML = `
          <button class="accept-btn" data-id="${emp.id}">Accept</button>
          <button class="decline-btn" data-id="${emp.id}">Archived</button>
        `;
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });

      attachStatusEvents();
    } catch (err) {
      console.error('‚ùå Error loading employers:', err);
      tbody.innerHTML = `<tr><td colspan="12">Error loading employers</td></tr>`;
    }
  }

  function buildPagination() {
    pageSelect.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const opt = new Option(`Page ${i}`, i, i === currentPage, i === currentPage);
      pageSelect.appendChild(opt);
    }
  }

  function attachStatusEvents() {
    document.querySelectorAll('.accept-btn').forEach(btn => {
      btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'ACCEPTED'));
    });
    document.querySelectorAll('.decline-btn').forEach(btn => {
      btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'ARCHIVED'));
    });
  }

  async function updateStatus(id, status) {
    const buttons = document.querySelectorAll(`[data-id="${id}"]`);
    buttons.forEach(b => b.disabled = true);
    try {
      const res = await fetch(`/api/employer/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      if (!res.ok) throw new Error(await res.text());
      await loadPage(currentPage);
    } catch (err) {
      console.error('‚ùå Update error:', err);
    } finally {
      buttons.forEach(b => b.disabled = false);
    }
  }

  // Initial load
  loadPage();

  // Loader animation
  let pct = 80;
  const loader = document.getElementById("loader-wrapper"),
        bar = document.getElementById("progress-bar"),
        pctEl = document.getElementById("percentage");

  if (loader && bar && pctEl) {
    const iv = setInterval(() => {
      if (pct < 100) {
        pct++;
        bar.style.width = pct + "%";
        pctEl.textContent = pct + "%";
      } else {
        clearInterval(iv);
        loader.style.display = "none";
      }
    }, 30);
  }
});
</script>

</body>
</html>