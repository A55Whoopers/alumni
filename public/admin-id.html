<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ID Request Database | TUP - Cavite</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <link rel="icon" type="image/png" href="/Logo2.png">

  <style>
    body { background:#f5f7fa; color:#111827; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .topbar { background:#fff; border-bottom:1px solid #e6e9ee; }
    .card-surface { background:#fff; border:1px solid #eef2f6; border-radius:10px; box-shadow:0 6px 18px rgba(16,24,40,0.04);}
    .small-muted { color:#64748b; font-size:.88rem; }
    .form-control, .form-select { border-radius:8px; }
    .table thead th { border-bottom:3px solid #000000; font-size: 15px;}
    #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
    .progress-bar-custom { width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin: auto;}
    @media print {
      body * { visibility: hidden; }
      #printTitle, #reqTable, #reqTable * { visibility: visible; }
      #reqTable th:last-child, #reqTable td:last-child { display: none; } /* hide Action */
      #reqTable { position: absolute; top: 40px; left:0; width:100%; }
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <nav class="topbar py-2">
    <div class="container d-flex align-items-center gap-3">
      <a class="btn btn-outline-secondary btn-sm" href="admin-homepage.html"><i class="fa-solid fa-arrow-left"></i></a>
      <div>
        <div class="fw-bold">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES – CAVITE</div>
        <div class="small-muted">ID Request Database — Admin</div>
      </div>
      <div class="ms-auto">
        <button class="btn btn-primary btn-sm" id="printBtn"><i class="fa-solid fa-print me-1"></i> Print Accepted Only</button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container my-4">
    <div class="row g-4">
      <!-- Left: controls -->
      <div class="col-lg-4">
        <div class="card-surface p-3">
          <label class="form-label small-muted mb-1">Search</label>
          <input id="searchInput" class="form-control mb-3" placeholder="Search by name…">

          <label class="form-label small-muted mb-1">Filter by Status</label>
          <select id="statusFilter" class="form-select mb-3">
            <option value="ALL">All Statuses</option>
            <option value="PENDING">Pending</option>
            <option value="ACCEPTED">Accepted</option>
            <option value="DECLINED">Declined</option>
          </select>

          <label class="form-label small-muted mb-1">Page</label>
          <select id="pageSelect" class="form-select mb-3"></select>
        </div>
      </div>

      <!-- Right: table -->
      <div class="col-lg-8">
        <div class="card-surface p-3">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="reqTable">
              <thead>
                <tr>
                  <th>NAME</th>
                  <th>DEGREE</th>
                  <th>YEAR</th>
                  <th>STUDENT NO</th>
                  <th>PHONE</th>
                  <th>EMAIL</th>
                  <th>VALID ID</th>
                  <th>STATUS</th>
                  <th>ACTION</th>
                  <th>SUBMITTED</th>
                </tr>
              </thead>
              <tbody id="reqBody"><tr><td colspan="10">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Loader -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div style="text-align:center;">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div style="width:360px; margin: auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" style="margin-top:10px; color:#6b7280;">0%</div>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('reqBody');
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const pageSelect = document.getElementById('pageSelect');
  const printBtn = document.getElementById('printBtn');
  const loaderWrapper = document.getElementById("loader-wrapper");
  const progressBar = document.getElementById("progress-bar");
  const percentageText = document.getElementById("percentage");

  let requests = [], currentPage = 1, totalPages = 1, LIMIT = 100;

  if (sessionStorage.getItem('userRole') !== 'admin') {
    return window.location.href = 'homepage.html';
  }

  // Loader
  (() => {
    let pct = 80;
    const iv = setInterval(() => {
      if (pct < 100) {
        pct++;
        progressBar.style.width = pct + "%";
        percentageText.textContent = pct + "%";
      } else {
        clearInterval(iv);
        loaderWrapper.style.display = "none";
      }
    }, 30);
  })();

  async function loadPage() {
    const search = encodeURIComponent(searchInput.value.trim());
    const url = `/api/requests/list?page=${currentPage}&limit=${LIMIT}${search ? `&search=${search}` : ''}`;
    const res = await fetch(url);
    const data = await res.json();
    requests = data.requests || [];
    totalPages = data.totalPages || 1;
    buildPagination();
    renderTable();
  }

  function buildPagination() {
    pageSelect.innerHTML = '';
    for (let i=1;i<=totalPages;i++){
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `Page ${i}`;
      if(i===currentPage) opt.selected = true;
      pageSelect.appendChild(opt);
    }
  }

  function renderTable(){
    const filter = statusFilter.value || 'ALL';
    tbody.innerHTML = '';
    const statusOrder = { PENDING:0, ACCEPTED:1, DECLINED:2 };

    requests.filter(r => filter==='ALL'||(r.status||'PENDING').toUpperCase()===filter)
      .sort((a,b)=>{
        const sa = statusOrder[(a.status||'PENDING').toUpperCase()];
        const sb = statusOrder[(b.status||'PENDING').toUpperCase()];
        return sa!==sb?sa-sb:b.id-a.id;
      })
      .forEach(r=>{
        const status = (r.status||'PENDING').toUpperCase();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.fullName}</td>
          <td>${r.degree}</td>
          <td>${r.yearGraduated}</td>
          <td>${r.studentNo}</td>
          <td>${r.phoneNo}</td>
          <td>${r.email}</td>
          <td><button class="btn btn-sm btn-outline-secondary">View</button></td>
          <td class="status ${status}">${status}</td>
          <td>
            <button class="btn btn-sm btn-success">Accept</button>
            <button class="btn btn-sm btn-danger">Decline</button>
          </td>
          <td>${r.submittedAt ? new Date(r.submittedAt).toLocaleDateString('en-US',{month:'long',day:'2-digit',year:'numeric'}).toUpperCase():'N/A'}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  // Print accepted only
  printBtn.addEventListener('click', ()=>{
    document.querySelectorAll('#reqBody tr').forEach(row=>{
      const status = row.querySelector('.status')?.innerText.trim();
      row.style.display = status==='ACCEPTED'?'':'none';
    });
    setTimeout(()=>window.print(),100);
    setTimeout(()=>document.querySelectorAll('#reqBody tr').forEach(row=>row.style.display=''),500);
  });

  pageSelect.addEventListener('change',()=>{currentPage=+pageSelect.value; loadPage();});
  searchInput.addEventListener('input',()=>{currentPage=1; loadPage();});
  statusFilter.addEventListener('change', renderTable);

  loadPage();
});
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
